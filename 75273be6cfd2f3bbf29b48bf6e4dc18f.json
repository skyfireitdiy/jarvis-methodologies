{
  "problem_type": "TDD规则库分离重构",
  "content": "## TDD规则库分离重构方法论\n\n### 问题重述\n当项目中存在包含大量正则表达式规则的模块时，规则与检查逻辑耦合，导致代码难以维护和扩展。需要将规则库独立到单独模块，同时使用TDD方法确保功能不变。\n\n### 可复用解决流程\n\n#### 阶段1：ANALYZE（分析阶段）\n1. **识别规则库**\n   - 定位规则定义位置（通常在文件顶部或特定区域）\n   - 统计规则数量和分类\n   - 评估规则占总代码的比例\n\n2. **分析规则使用**\n   - 搜索所有规则引用位置\n   - 识别规则类别和关联逻辑\n   - 评估规则引用的复杂度\n\n3. **设定合理目标**\n   - 行数减少目标需基于实际情况（规则库占总代码比例）\n   - 测试覆盖率目标（建议>=80%）\n   - 功能一致性要求（所有测试必须通过）\n\n#### 阶段2：TDD红-绿-重构循环\n\n**红阶段（编写测试）**\n1. 创建规则库测试文件（test_*_rules.py）\n2. 为每个规则类编写测试\n3. 验证规则对象的类型和匹配能力\n4. 确保测试失败（规则库尚未创建）\n\n**绿阶段（实现规则库）**\n1. 创建独立的规则库文件（*_rules.py）\n2. 按类别组织规则类（使用静态属性存储编译后的正则表达式）\n3. 迁移所有规则定义，保持re.compile()和编译标志不变\n4. 运行测试确保通过\n\n**重构阶段（替换引用）**\n1. 在主文件中添加规则库导入\n2. 逐个替换规则引用（从本地变量改为规则类属性）\n3. 删除原始规则定义\n4. 每替换一类规则后立即验证\n\n#### 阶段3：验证和验收\n1. 运行现有测试套件（验证功能一致性）\n2. 运行规则库测试（验证规则正确性）\n3. 统计代码行数（评估重构效果）\n4. 对比重构前后行为\n\n### 注意事项\n\n**行数目标设定**\n- 规则库通常只占总代码的5-10%，仅独立规则库无法大幅减少主文件行数\n- 如果目标是主文件<1000行，需要评估规则库占比和检查逻辑复杂度\n- 建议设定阶段目标：规则库独立（基础目标）→ 检查逻辑拆分（进阶目标）\n\n**测试策略**\n- 为每个规则类创建测试类\n- 每个规则至少一个测试用例验证类型和匹配能力\n- 测试引用保持不变（通过别名导出规则属性）\n\n**引用替换**\n- 使用精确搜索确保替换准确性\n- 按类别批量替换，减少修改次数\n- 每次替换后立即运行测试验证\n\n**验收标准**\n1. 测试覆盖率>=80%\n2. 所有测试通过（现有测试+规则库测试）\n3. 功能行为与重构前完全一致\n4. 规则库可独立扩展（新增规则只需修改规则库文件）\n5. 代码行数达到设定目标（需基于实际情况）\n\n### 可选步骤\n\n#### 进阶重构（当基础重构完成后）\n1. **拆分检查函数**\n   - 按功能模块拆分大型_rule_*函数\n   - 提取公共逻辑到辅助函数\n\n2. **模块化组织**\n   - 将不同类别的检查逻辑分离到独立模块\n   - 如：内存管理检查、线程安全检查、缓冲区检查等\n\n3. **消除重复代码**\n   - 识别重复的模式和逻辑\n   - 提取为可复用的函数或类\n\n4. **简化复杂逻辑**\n   - 降低函数圈复杂度\n   - 拆分过长函数\n   - 优化条件判断\n\n### 适用场景\n- 任何包含大量正则表达式规则的模块\n- 规则与检查逻辑耦合的代码\n- 需要提升规则可维护性和扩展性的项目\n\n### 不适用场景\n- 规则数量很少（<5个）的模块\n- 规则与逻辑高度耦合，难以分离的场景\n- 规则需要动态修改或配置的场景",
  "scope": "global"
}