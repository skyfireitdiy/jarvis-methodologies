{
  "problem_type": "Rust嵌套函数迁移到模块级别",
  "content": "问题类型：Rust代码重构 - 将嵌套在函数内部的辅助函数迁移到模块级别，使其成为公共接口\n\n适用场景：\n1. 函数内部定义的嵌套函数被测试用例或其他模块需要使用\n2. 嵌套函数需要访问全局状态但作用域受限\n3. 需要提高代码可测试性和可重用性\n\n解决流程：\n\n1. **识别与评估**\n   - 使用read_code工具检查目标函数内部是否包含嵌套函数定义\n   - 评估这些函数是否具有公共使用价值\n   - 确认函数是否依赖全局状态\n\n2. **状态管理设计**\n   - 如果函数需要维护状态，使用once_cell::sync::Lazy<Mutex<T>>实现线程安全的全局状态\n   - 示例：static INCLUDE_NEXT_IDX: Lazy<Mutex<usize>> = Lazy::new(|| Mutex::new(0))\n\n3. **函数迁移步骤**\n   - 将嵌套函数定义从原函数内部移动到模块级别（文件顶部或相关函数之后）\n   - 添加pub修饰符使其成为公共接口：pub fn function_name()\n   - 保持函数签名和实现逻辑完全不变\n   - 确保全局状态的访问方式保持一致\n\n4. **验证与测试**\n   - 使用read_code检查原函数内部是否已移除嵌套函数定义\n   - 确认新位置函数是否有pub修饰符\n   - 执行cargo build确保编译通过\n   - 执行相关测试用例确保功能不受影响\n   - 验证测试无需修改即可通过\n\n5. **清理与优化**\n   - 检查是否有重复的函数定义\n   - 确保文档注释跟随函数一起迁移\n   - 验证IDE跳转和代码补全功能正常\n\n注意事项：\n- 保持最小改动原则，避免引入破坏性变更\n- 函数签名必须保持不变以维持API兼容性\n- 如果函数依赖闭包变量，需要先重构为参数传递\n- 全局状态初始化应在模块加载时完成\n\n工具组合：\n- read_code：验证函数位置和定义\n- cargo test：验证重构后的功能正确性\n- cargo build：确保编译通过"
}