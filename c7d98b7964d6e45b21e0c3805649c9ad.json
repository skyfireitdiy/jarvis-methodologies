{
  "problem_type": "Rust并发测试状态污染",
  "content": "# Rust并发测试状态污染解决方法论\n\n## 问题重述\n在Rust项目中，使用全局静态变量（如`static`、`Atomic*`类型）时，测试框架默认并发执行会导致测试间状态污染，出现以下症状：\n1. 单独运行测试用例通过\n2. 并发运行测试套件时失败\n3. 失败模式与测试执行顺序相关\n4. 期望值与实际值出现系统性偏移\n\n## 可复用解决流程\n\n### 步骤1：定位问题\n1. 使用`cargo test -- --nocapture`收集失败信息\n2. 对比单独运行`cargo test 模块名::测试名`与并发运行的差异\n3. 确认是否涉及全局状态变量\n\n### 步骤2：临时验证\n```bash\n# 验证是否为并发问题\ncargo test -- --test-threads=1\n```\n若单线程通过而并发失败，可确认竞态条件问题。\n\n### 步骤3：根本解决\n选择以下方案之一：\n\n#### 方案A：测试隔离（推荐）\n```rust\n#[cfg(test)]\nfn reset_global_state() {\n    GLOBAL_VAR.store(0, Ordering::Relaxed);\n}\n\n#[test]\nfn test_with_isolation() {\n    reset_global_state();\n    // 测试逻辑\n}\n```\n\n#### 方案B：并发控制\n```bash\n# CI/CD中强制单线程\ncargo test -- --test-threads=1\n```\n\n#### 方案C：重构设计\n- 避免全局状态，使用依赖注入\n- 使用线程局部存储`thread_local!`\n\n### 步骤4：验证修复\n1. 运行完整测试套件：`cargo test -- --test-threads=1`\n2. 确认所有测试稳定通过\n3. 多次运行确认无随机失败\n\n## 注意事项\n- 原子类型（Atomic*）虽线程安全，但仍存在跨测试状态问题\n- 测试用例必须显式重置全局状态\n- CI/CD配置中应考虑并发控制策略\n- 长期方案建议消除全局可变状态"
}