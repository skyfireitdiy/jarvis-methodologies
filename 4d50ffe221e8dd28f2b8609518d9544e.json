{
  "problem_type": "C编译器移植到Rust",
  "content": "## 问题重述\n将C语言编写的编译器（如chibicc）完整移植到Rust，需要保持功能等价性，包括词法分析器、语法分析器、代码生成等核心组件。\n\n## 可复用解决流程\n\n### 阶段1：代码分析与准备\n1. **识别核心数据结构**\n   - 使用read_code工具读取C头文件，识别关键结构体\n   - 使用read_symbols工具查找符号定义\n   - 建立C→Rust结构体映射表\n\n2. **函数依赖分析**\n   - 从main函数开始，使用lsp_client查找所有调用链\n   - 构建函数调用图，识别最底层依赖\n   - 按依赖层级排序实现顺序\n\n### 阶段2：基础工具函数移植\n1. **错误处理机制**\n   - 将C的error/error_at/error_tok转换为Rust的Result/Error\n   - 实现错误位置追踪（文件名、行号、列号）\n\n2. **内存管理转换**\n   - C的calloc/malloc → Rust的Box/Vec\n   - C的字符串处理 → Rust的String/&str\n   - 实现内存安全的字符串操作\n\n### 阶段3：词法分析器移植\n1. **数据结构映射**\n   ```\n   C TokenKind → Rust TokenKind\n   C Token → Rust Token\n   C File → Rust File (新增)\n   ```\n\n2. **核心函数等价实现**\n   - new_token → Token::new_with_context\n   - read_ident → 字符类型判断函数\n   - read_punct → 运算符识别函数\n   - tokenize → 主词法分析函数\n   - tokenize_file → 文件读取+token化\n\n3. **状态管理**\n   - C的全局变量 → Rust的结构体字段\n   - at_bol, has_space → Tokenizer状态\n\n### 阶段4：测试验证\n1. **单元测试移植**\n   - 将C的测试用例转为Rust测试\n   - 使用相同输入验证输出一致性\n\n2. **集成测试**\n   - 确保cargo test全部通过\n   - 验证无回归问题\n\n## 注意事项\n- 保持接口兼容性：must_tokenize_file签名不变\n- 避免使用unsafe代码块\n- 优先使用标准库，避免外部依赖\n- 保留原有错误处理语义\n- 中文注释要求\n\n## 可选步骤\n- 性能优化：使用String interning减少内存分配\n- 错误恢复：实现更好的错误提示\n- Unicode支持：完全支持UTF-8"
}