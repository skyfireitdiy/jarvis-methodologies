{
  "problem_type": "Rust项目批量添加双模式构建支持",
  "content": "# Rust 项目批量添加双模式构建支持\n\n## 规则简介\n\n本方法论用于指导为多个 Rust 项目批量添加 dylib/src 双模式构建支持，提升代码复用性和构建灵活性。\n\n## 你必须遵守的原则\n\n### 批量改造原则\n\n**要求说明：**\n\n- **必须**：使用任务列表管理器拆分任务，按项目逐个执行，避免大范围一次性修改\n- **必须**：每个项目改造完成后立即验证编译，确保功能未受影响\n- **必须**：使用 `cargo build --release -p <package_name>` 指定包名验证，避免全量编译\n- **必须**：保留原有 features 配置，仅添加双模式支持\n\n- **禁止**：在未验证前改造多个项目\n- **禁止**：删除或修改已有的 features 配置\n- **禁止**：破坏现有功能\n\n### 配置一致性原则\n\n**要求说明：**\n\n- **必须**：所有项目使用相同的双模式构建模式（dylib/src features）\n- **必须**：src feature 设置为默认（default = [\"src\"]）\n- **必须**：idf 依赖设置 optional = true\n- **必须**：build.rs 使用 #[cfg(feature = \"dylib\")] 条件编译\n- **必须**：源码中 extern crate idf 添加条件编译\n\n- **禁止**：混淆 features 的用途（features 只能包含依赖项，不能包含非依赖的标记）\n- **禁止**：在 src feature 中重复 idf 依赖的 features 标记\n\n## 你必须执行的操作\n\n### 阶段1：准备工作\n\n1. **收集项目列表**：明确需要改造的所有项目名称和路径\n2. **分析现有配置**：读取每个项目的 Cargo.toml，了解现有的 idf 依赖和 features 配置\n3. **确定改造策略**：根据现有配置决定如何设置双模式支持\n   - 无 idf 依赖：添加 idf 依赖 + features\n   - 有 idf 依赖：添加 optional + features（保持原有配置）\n\n### 阶段2：单个项目改造\n\n对每个项目依次执行以下步骤：\n\n1. **修改 Cargo.toml**：\n   - idf 依赖添加 `optional = true`\n   - 添加 features 配置：\n```toml\n[features]\ndylib = []\ndefault = [\"src\"]\nsrc = [\"idf\"]\n```\n   - 保持原有的 features 配置（如果有）\n\n2. **创建/修改 build.rs**：\n   - 使用 `#[cfg(feature = \"dylib\")]` 条件编译\n   - 配置动态库搜索路径和链接：\n```rust\nfn main() {\n    #[cfg(feature = \"dylib\")]\n    {\n        let idf_lib_path = \"target/cgel-x86_64-release-all\";\n        println!(\"cargo:rustc-link-search={}\", idf_lib_path);\n        println!(\"cargo:rustc-link-lib=dylib=idf\");\n}\n}\n```\n   - 根据项目需求配置额外的动态库（如 pubsub）\n\n3. **修改源码**：\n   - 搜索所有 `extern crate idf;` 声明\n   - 添加条件编译：`#[cfg(feature = \"dylib\")] extern crate idf;`\n\n4. **验证编译**：\n   - 执行 `cargo build --release -p <package_name>` 验证编译\n   - 确保编译成功且无错误\n\n### 阶段3：完成验证\n\n1. **批量验证**：所有项目改造完成后，统一验证编译\n2. **文档更新**：更新相关文档，记录双模式构建支持\n3. **提交代码**：提交所有修改，确保可回退\n\n## 实践指导\n\n### 常见配置模式\n\n**基础配置（无额外 features）**：\n```toml\n[dependencies]\nidf = { path = \"../../idf\", optional = true }\n\n[features]\ndylib = []\ndefault = [\"src\"]\nsrc = [\"idf\"]\n```\n\n**带原有 features（如 comm_pubsub）**：\n```toml\n[dependencies]\nidf = { path = \"../../idf\", features = [\"all\", \"comm_pubsub\"], optional = true }\n\n[features]\ndylib = []\ndefault = [\"src\"]\nsrc = [\"idf\"]\n```\n\n注意：src feature 只包含 [\"idf\"]，原有 features 由 idf 依赖的 features 参数管理。\n\n### build.rs 配置技巧\n\n**基础配置**：\n```rust\nfn main() {\n    #[cfg(feature = \"dylib\")]\n    {\n        let idf_lib_path = \"target/cgel-x86_64-release-all\";\n        println!(\"cargo:rustc-link-search={}\", idf_lib_path);\n        println!(\"cargo:rustc-link-lib=dylib=idf\");\n}\n}\n```\n\n**带额外库配置（如 pubsub）**：\n```rust\nfn main() {\n    #[cfg(feature = \"dylib\")]\n    {\n        let idf_lib_path = \"target/cgel-x86_64-release-all\";\n        println!(\"cargo:rustc-link-search={}\", idf_lib_path);\n        println!(\"cargo:rustc-link-lib=dylib=idf\");\n        println!(\"cargo:rustc-link-lib=dylib=pubsub\");\n        println!(\"cargo:rustc-link-lib=dylib=tcfs\");\n}\n}\n```\n\n### 常见错误\n\n1. **features 配置错误**：\n   - 错误：src = [\"idf\", \"all\", \"comm_pubsub\"]\n   - 正确：src = [\"idf\"]（all 和 comm_pubsub 是 idf 的 feature，由 idf 依赖的 features 参数管理）\n\n2. **条件编译未闭合**：\n   - 错误：忘记添加闭合大括号 `}`\n   - 正确：确保所有条件编译块都有对应的闭合大括号\n\n3. **extern crate 位置错误**：\n   - 错误：条件编译放在 extern crate 之后\n   - 正确：`#[cfg(feature = \"dylib\")] extern crate idf;`\n\n## 检查清单\n\n- [ ] 所有项目都已收集并分析\n- [ ] 每个项目的 Cargo.toml 都已添加 optional 和 features\n- [ ] 每个项目的 build.rs 都已创建或修改\n- [ ] 每个项目的源码都已添加条件编译\n- [ ] 每个项目都使用 `cargo build --release -p <package_name>` 验证通过\n- [ ] 所有项目编译成功，无错误\n- [ ] 文档已更新（如需要）\n- [ ] 代码已提交，可回退",
  "scope": "global"
}