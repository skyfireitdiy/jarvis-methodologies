{
  "problem_type": "cargo_feature_dot_verification",
  "content": "# Cargo Feature 依赖图 DOT 文件验证方法论\n\n## 规则简介\n\n本方法论用于验证从 Cargo.toml 解析生成的 Graphviz DOT 依赖图文件是否完整、正确。适用于需要验证 feature 依赖关系可视化输出的场景。\n\n## 你必须遵守的原则\n\n### 完整性验证原则\n\n**要求说明：**\n\n- **必须**：验证 DOT 文件包含所有在 Cargo.toml [features] 部分定义的 feature\n- **必须**：验证依赖边与 Cargo.toml 中的定义一致\n- **禁止**：遗漏任何 feature 节点，即使是空的 feature（如 `tools_core = []`）\n\n### 语法正确性原则\n\n**要求说明：**\n\n- **必须**：DOT 文件必须能被 `dot` 命令成功解析\n- **必须**：所有节点和边的语法必须符合 Graphviz DOT 格式规范\n- **禁止**：输出包含语法错误的 DOT 文件\n\n### 准确性验证原则\n\n**要求说明：**\n\n- **必须**：依赖关系方向必须正确（A 依赖 B 表示为 A -> B）\n- **必须**：间接依赖关系必须被正确解析和表示\n- **禁止**：添加 Cargo.toml 中不存在的依赖关系\n\n## 你必须执行的操作\n\n### 阶段1：基础文件验证\n\n1. **文件存在性检查**：验证 DOT 文件是否存在于指定路径\n```bash\n   ls -lh /tmp/output.dot\n```\n\n2. **DOT 语法验证**：使用 Graphviz dot 命令验证语法正确性\n```bash\n   dot -Tpng input.dot -o /tmp/test.png\n```\n\n3. **解析错误检查**：如果 dot 命令失败，检查错误信息并定位问题\n\n### 阶段2：节点完整性验证\n\n1. **提取 Cargo.toml 中的所有 feature**：\n```bash\n   # 提取指定行号范围的 feature 定义\n   sed -n '87,175p' idf/Cargo.toml | grep ' = ' | sed 's/ = .*//' | grep -v ']' | sort -u\n```\n\n2. **提取 DOT 文件中的所有节点**：\n```bash\n   # 排除图例节点，只统计 feature 节点\n   grep -E '^\\s*[a-z_]+\\s+\\[fillcolor=' input.dot | grep -v legend | wc -l\n```\n\n3. **对比节点数量**：确保两个列表中的 feature 数量一致\n```bash\n   # 使用 comm 命令对比差异\n   comm -23 cargo_features.txt dot_features.txt  # Cargo 有但 DOT 没有\n   comm -13 cargo_features.txt dot_features.txt  # DOT 有但 Cargo 没有\n```\n\n### 阶段3：依赖关系验证\n\n1. **统计依赖边数量**：\n```bash\n   grep '\\\\->' input.dot | grep -v '//' | grep -v 'cluster' | wc -l\n```\n\n2. **验证关键依赖关系**：\n   - 检查 default -> all 依赖\n   - 检查 all 的所有子依赖数量是否正确\n   - 检查典型 feature 的依赖（如 sche, moni）\n\n3. **对比 Cargo.toml 定义**：\n   - 验证每个 feature 的依赖是否与 Cargo.toml 中定义一致\n   - 注意区分 feature 依赖和外部 crate 依赖\n\n### 阶段4：可视化验证\n\n1. **检查节点样式**：\n   - 验证不同类型的 feature 是否使用了不同的颜色\n   - 检查节点标签是否清晰（包含 feature 名称和类型）\n\n2. **检查边样式**：\n   - 验证依赖边是否使用了合适的标签（如\"依赖\"、\"包含\"）\n   - 检查边的方向是否正确\n\n## 实践指导\n\n### 常见问题\n\n1. **节点数量不匹配**：\n   - 原因：可能遗漏了空的 feature 定义（如 `tools_core = []`）\n   - 解决：仔细检查 Cargo.toml 中所有以 `feature_name = [` 开头的行\n\n2. **依赖关系缺失**：\n   - 原因：解析时可能只提取了直接的 feature 依赖，忽略了间接依赖\n   - 解决：递归解析所有依赖层级\n\n3. **DOT 语法错误**：\n   - 原因：节点名包含特殊字符或格式错误\n   - 解决：确保节点名是合法的标识符，使用引号包裹\n\n### 验证脚本建议\n\n可以编写一个完整的验证脚本，自动化执行所有验证步骤：\n\n```bash\n#!/bin/bash\nCARGO_FILE=\"idf/Cargo.toml\"\nDOT_FILE=\"/tmp/idf_features.dot\"\n\necho \"=== 开始验证 ===\"\necho \"1. 检查文件存在性\"\ntest -f \"$DOT_FILE\" || { echo \"DOT 文件不存在\"; exit 1; }\n\necho \"2. 验证 DOT 语法\"\ndot -Tpng \"$DOT_FILE\" -o /tmp/test.png || { echo \"DOT 语法错误\"; exit 1; }\n\necho \"3. 提取 feature 列表\"\nsed -n '87,175p' \"$CARGO_FILE\" | grep ' = ' | sed 's/ = .*//' | grep -v ']' | sort -u > /tmp/cargo.txt\ngrep -E '^\\s*[a-z_]+\\s+\\[fillcolor=' \"$DOT_FILE\" | grep -v legend | sed 's/ .*//' | sed 's/^\\s*//' | sort > /tmp/dot.txt\n\necho \"4. 对比节点数量\"\nCARGO_COUNT=$(wc -l < /tmp/cargo.txt)\nDOT_COUNT=$(wc -l < /tmp/dot.txt)\necho \"Cargo.toml: $CARGO_COUNT 个 feature\"\necho \"DOT 文件: $DOT_COUNT 个节点\"\n\nif [ \"$CARGO_COUNT\" -eq \"$DOT_COUNT\" ]; then\n    echo \"✓ 节点数量一致\"\nelse\n    echo \"✗ 节点数量不一致\"\n    comm -23 /tmp/cargo.txt /tmp/dot.txt\n    comm -13 /tmp/cargo.txt /tmp/dot.txt\nfi\n\necho \"=== 验证完成 ===\"\n```\n\n## 检查清单\n\n- [ ] DOT 文件存在于指定路径\n- [ ] DOT 文件可被 `dot` 命令成功解析\n- [ ] 节点数量与 Cargo.toml 中的 feature 数量一致\n- [ ] 所有 feature 名称都正确包含在 DOT 文件中\n- [ ] 依赖关系边的数量合理\n- [ ] 关键依赖关系（如 default -> all）正确表示\n- [ ] 不同类型的 feature 使用了不同的颜色或样式\n- [ ] 节点和边的标签清晰可读\n- [ ] 图例（如果有）正确说明不同颜色的含义",
  "scope": "global"
}