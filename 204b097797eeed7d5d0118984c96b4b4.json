{
  "problem_type": "C转Rust项目的宏定义功能修复",
  "content": "# C转Rust宏定义功能修复方法论\n\n## 问题重述\n在C到Rust的转译项目中，需要实现与C版本功能一致的宏定义系统，包括内置宏（__FILE__, __LINE__, __COUNTER__, __TIMESTAMP__, __BASE_FILE__）的动态处理机制。\n\n## 可复用解决流程\n\n### 步骤1：功能映射分析\n- 使用`read_code`查看C版本宏处理实现\n- 识别关键数据结构：宏名称→处理函数的映射关系\n- 记录所有需要支持的内置宏列表\n\n### 步骤2：Rust架构设计\n- 创建`BuiltinMacro` trait定义统一接口：`fn expand(&self, context: &MacroContext) -> Vec<Token>`\n- 为每个内置宏创建独立结构体实现该trait\n- 在`PreprocessorState`中添加`HashMap<String, Box<dyn BuiltinMacro>>`存储注册关系\n\n### 步骤3：动态注册机制\n- 实现`add_builtin`方法向HashMap注册宏处理器\n- 使用`Box<dyn Trait>`实现运行时多态\n- 在`init_macros`中统一注册所有内置宏\n\n### 步骤4：条件编译处理\n- **时间宏特殊处理**：\n  ```rust\n  #[cfg(test)]\n  fn expand(&self, _context: &MacroContext) -> Vec<Token> {\n      // 测试环境使用固定值\n  }\n  #[cfg(not(test))]\n  fn expand(&self, _context: &MacroContext) -> Vec<Token> {\n      // 生产环境使用std::time动态生成\n  }\n  ```\n\n### 步骤5：测试策略\n- **单元测试**：为每个内置宏创建独立测试\n- **集成测试**：验证宏展开后的代码生成\n- **断言策略**：使用包含性断言避免格式依赖\n  ```rust\n  assert!(output.iter().any(|line| line.contains(\"expected_content\")));\n  ```\n\n### 步骤6：兼容性验证\n- 运行完整测试套件（160+测试用例）\n- 识别并修复格式敏感的测试断言\n- 采用渐进式修复：先修复核心功能，再调整测试\n\n## 注意事项\n1. **依赖约束**：必须使用标准库，禁用第三方crate\n2. **性能考量**：宏展开在预处理阶段完成，不影响运行时性能\n3. **线程安全**：BuiltinMacro实现需为Send+Sync\n4. **回退机制**：每次修改前使用git创建检查点\n\n## 可选步骤\n- 添加更多内置宏时遵循相同模式\n- 可扩展为支持用户自定义宏处理器"
}