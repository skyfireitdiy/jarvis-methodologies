{
  "problem_type": "C语言头文件审查",
  "content": "# C语言头文件审查方法论\n\n## 规则简介\n\n本方法论提供了C语言头文件代码审查的系统化流程和检查要点，适用于审查对外接口定义、数据结构设计、宏定义和文档完整性。通过遵循此方法论，可以全面发现头文件中的潜在问题，确保接口设计的正确性、安全性和可维护性。\n\n## 你必须遵守的原则\n\n### 全面性原则\n\n**要求说明：**\n\n- **必须**：从接口设计、数据结构、宏定义、函数声明、文档完整性五个维度进行全面审查\n- **必须**：每个发现的问题都要标注精确的行号（文件:行号格式）\n- **禁止**：跳过任何一个审查维度或仅关注某一类问题\n\n### 严重程度分级原则\n\n**要求说明：**\n\n- **必须**：将问题按严重程度分为严重（阻塞合入）、中等（建议修复）、低优先级三个级别\n- **必须**：严重问题包括：拼写错误、类型不一致、未定义行为、安全漏洞\n- **必须**：中等问题包括：性能优化、可维护性改进、设计缺陷\n- **必须**：低优先级问题包括：代码风格、注释格式、命名建议\n- **禁止**：将严重问题降级为中等或低优先级\n\n### 深度分析原则\n\n**要求说明：**\n\n- **必须**：对非风格类问题进行深度分析，包括数据流、控制流、触发条件\n- **必须**：说明问题的影响范围和潜在风险\n- **必须**：提供具体的修复建议和代码示例\n- **禁止**：仅描述问题表象而不分析根本原因\n\n## 你必须执行的操作\n\n### 阶段1：准备阶段\n\n1. **读取文件内容**：使用 `read_code` 工具读取头文件的完整内容\n2. **理解设计意图**：分析头文件的整体架构和设计目的\n3. **识别关键组件**：标记接口函数、数据结构、宏定义等关键元素\n\n### 阶段2：接口设计审查\n\n1. **检查命名一致性**：\n   - 函数命名是否符合项目规范（前缀、命名风格）\n   - 是否存在拼写错误（特别注意 Store/Stroe 这类错误）\n   - 类型命名是否语义清晰\n\n2. **验证参数设计**：\n   - 参数类型是否合理（避免过宽或过窄）\n   - 参数顺序是否符合直觉\n   - 是否缺少必要的参数验证宏\n\n3. **评估返回值设计**：\n   - 返回值类型是否统一（建议统一使用错误码）\n   - 是否正确使用 VOID/WORD32/BOOLEAN\n   - 错误码定义是否完整\n\n4. **检查版本管理**：\n   - 是否有版本宏定义（MAJOR/MINOR VERSION）\n   - 是否支持编译时API兼容性检查\n\n### 阶段3：数据结构审查\n\n1. **类型一致性检查**：\n   - 同一含义的字段在不同结构体中是否使用相同类型\n   - 特别关注 BYTE vs WORD32、有符号 vs 无符号的差异\n   - 检查：`oss_commfilter.h:103 (BYTE ucFilterLocation)` vs `127 (WORD32 dwFilterLocation)`\n\n2. **有符号/无符号类型检查**：\n   - 表示长度、大小、计数的字段应使用无符号类型\n   - 检查是否使用 SWORD32 表示队列长度、数组大小等\n   - 特殊值（如 -2 表示未启动）应单独使用状态字段\n\n3. **内存对齐优化**：\n   - 结构体字段是否按大小排序（减少padding）\n   - 是否存在可优化的内存布局\n   - 是否考虑了缓存行利用率\n\n4. **结构体完整性**：\n   - 结构体字段是否有完整的注释说明\n   - 是否包含未初始化的指针字段\n   - 是否说明了内存管理责任\n\n### 阶段4：宏定义审查\n\n1. **参数括号保护**：\n   - 所有宏参数是否使用括号保护\n   - 检查模式：`#define MACRO(param) (expression)` 而非 `#define MACRO(param) expression`\n   - 特别检查包含运算符的宏\n\n2. **位运算宏安全**：\n   - 位移宏是否检查参数范围（避免未定义行为）\n   - 检查：`#define GET_FLAG(id) (1 << (id))` 应改为 `((id) < 32 ? (1UL << (id)) : 0)`\n   - 是否使用了正确的数据类型（unsigned）\n\n3. **宏复杂度**：\n   - 是否存在过于复杂的宏定义（建议改为 inline 函数）\n   - 检查宏嵌套层次是否过深\n   - 是否使用了 do-while(0) 包装多语句宏\n\n4. **魔数检查**：\n   - 是否使用魔数而非命名常量\n   - 检查：`(5 * 1024 * 1024)` 应定义为 `#define LOG_SIZE_MB 5`\n\n### 阶段5：函数声明审查\n\n1. **声明一致性**：\n   - 头文件声明与实际定义是否匹配\n   - 参数类型、数量、顺序是否一致\n   - 是否使用了正确的类型修饰符\n\n2. **回调函数类型**：\n   - 函数指针类型定义是否正确\n   - 回调参数设计是否合理\n   - 是否支持上下文参数\n\n3. **extern 声明**：\n   - 是否正确使用 extern（C++兼容性）\n   - 是否有重复声明\n\n### 阶段6：注释和文档审查\n\n1. **公共接口文档**：\n   - 所有公共接口是否有完整的 Doxygen 风格注释\n   - 是否包含 @brief、@param、@return、@note 等标签\n   - 参数说明是否包含单位、取值范围\n\n2. **枚举值文档**：\n   - 每个枚举值是否有使用场景说明\n   - 是否有使用示例\n   - 是否说明了枚举值的含义\n\n3. **结构体成员文档**：\n   - 每个字段是否有注释说明\n   - 是否说明了字段的有效范围\n   - 是否说明了内存管理责任\n\n4. **代码清理**：\n   - 删除注释掉的代码（应使用版本控制管理）\n   - 删除临时标记（如 AI 生成标记）\n   - 统一注释风格\n\n### 阶段7：线程安全审查\n\n1. **全局变量声明**：\n   - 是否声明了全局变量或静态变量\n   - 是否说明了线程安全属性\n\n2. **接口线程安全**：\n   - 每个公共接口是否说明了线程安全性\n   - 是否需要调用者保证同步\n   - 是否支持多线程并发调用\n\n3. **回调函数安全**：\n   - 回调函数是否在多线程环境下调用\n   - 是否说明了回调的执行上下文\n\n### 阶段8：问题整理和报告\n\n1. **问题分类**：\n   - 按严重程度分类：严重/中等/低\n   - 每个问题添加【Jarvis Agent自主评审】前缀\n   - 标注精确行号（文件:行号格式）\n\n2. **深度分析**：\n   - 对非风格类问题分析数据流、控制流\n   - 说明触发条件和影响范围\n   - 提供具体的修复建议\n\n3. **生成报告**：\n   - 汇总严重问题数量\n   - 提供接口设计改进建议\n   - 给出总体评价\n\n## 实践指导\n\n### 常见陷阱\n\n1. **拼写错误**：特别注意 Store、Receive、Length 等常见词的拼写\n2. **类型不一致**：同一概念在不同结构体中使用不同类型\n3. **宏参数未加括号**：导致优先级错误\n4. **有符号类型表示长度**：导致溢出和比较错误\n5. **位移未检查范围**：32位系统上 `1 << 32` 是未定义行为\n\n### 审查技巧\n\n1. **对比审查**：将相似的结构体放在一起对比，发现不一致\n2. **工具辅助**：使用 `grep` 或 `rg` 搜索特定模式\n3. **交叉引用**：检查头文件声明与源文件定义的一致性\n4. **场景分析**：考虑多线程、异常输入等边界情况\n\n### 优先级判断\n\n- **严重**：导致编译错误、运行时崩溃、安全漏洞、数据损坏\n- **中等**：性能问题、可维护性问题、设计缺陷\n- **低**：代码风格、注释格式、命名建议\n\n## 检查清单\n\n### 接口设计\n\n- [ ] 函数命名一致性（前缀、风格）\n- [ ] 参数类型合理性\n- [ ] 返回值类型统一性\n- [ ] 版本管理宏定义\n\n### 数据结构\n\n- [ ] 类型一致性（同一概念同一类型）\n- [ ] 有符号/无符号类型正确性\n- [ ] 内存对齐优化\n- [ ] 结构体字段注释完整性\n\n### 宏定义\n\n- [ ] 宏参数括号保护\n- [ ] 位运算宏范围检查\n- [ ] 宏复杂度控制\n- [ ] 魔数消除\n\n### 函数声明\n\n- [ ] 声明与定义一致性\n- [ ] 回调函数类型正确性\n- [ ] extern 声明正确性\n\n### 文档\n\n- [ ] 公共接口完整注释\n- [ ] 枚举值使用说明\n- [ ] 结构体字段注释\n- [ ] 注释代码清理\n\n### 线程安全\n\n- [ ] 全局变量声明检查\n- [ ] 接口线程安全说明\n- [ ] 回调函数安全说明",
  "scope": "global"
}