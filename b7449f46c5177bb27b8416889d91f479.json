{
  "problem_type": "Rust Cargo feature冗余检查",
  "content": "# Rust Cargo Feature 冗余检查方法论\n\n## 规则简介\n\n本方法论提供了一套标准化的流程，用于检查 Rust 项目中 build.sh 或构建脚本中的 feature 参数是否冗余。通过对比 Cargo.toml 中 `all` feature 的定义，识别并优化不必要的 feature 设置，简化构建配置。\n\n## 你必须遵守的原则\n\n### 原则1：理解 Feature 层级结构\n\n**要求说明：**\n\n- **必须**：理解 Rust Cargo feature 的层级关系\n- **必须**：区分顶层 feature 和子模块 feature\n- **必须**：识别 `all` feature 包含的组件范围\n- **禁止**：将子模块 feature 视为冗余（除非它确实包含在 `all` 中）\n\n### 原则2：准确解析依赖关系\n\n**要求说明：**\n\n- **必须**：从 Cargo.toml 的 `[features]` 节点准确提取 feature 定义\n- **必须**：递归解析 feature 的依赖关系（如 `all = [\"comm\", \"hotpatch\"]`）\n- **必须**：识别间接依赖（如 `comm` 可能依赖其他子 feature）\n- **禁止**：仅基于 feature 名称进行判断\n\n### 原则3：验证实际需求\n\n**要求说明：**\n\n- **必须**：在移除 feature 前，验证项目确实不需要该 feature\n- **必须**：考虑特定测试或场景可能需要额外的子模块 feature\n- **禁止**：盲目移除看似冗余的 feature\n\n## 你必须执行的操作\n\n### 阶段1：解析 Feature 定义\n\n1. **读取 Cargo.toml**：解析 `[features]` 节点，提取所有 feature 定义\n2. **分析 all feature**：识别 `all` feature 包含的所有组件（直接和间接依赖）\n3. **建立 feature 集合**：创建两个集合：\n   - `all_features`: `all` feature 包含的所有 feature\n   - `additional_features`: 不在 `all` 中的独立 feature\n\n### 阶段2：检查构建脚本\n\n1. **定位构建脚本**：查找所有 build.sh、build.rs 或相关构建配置文件\n2. **提取 feature 参数**：从构建脚本中提取 `-f` 或 `--features` 参数\n3. **分析 feature 组合**：将 feature 参数按逗号分割，得到 feature 列表\n\n### 阶段3：识别冗余\n\n1. **对比检查**：对于每个构建脚本的 feature 列表：\n   - 如果包含 `all`，检查是否还包含 `all_features` 中的其他 feature\n   - 标记这些 feature 为潜在冗余\n2. **验证子模块**：检查标记的冗余 feature 是否真的是子模块：\n   - 如果是 `all` 的子 feature，确认是否确实不需要\n   - 如果是独立 feature，标记为非冗余\n3. **生成报告**：输出冗余 feature 的位置和详情\n\n### 阶段4：优化建议\n\n1. **生成优化建议**：为每个冗余 feature 提供移除建议\n2. **风险评估**：评估移除 feature 可能的影响\n3. **提供优化方案**：给出优化后的 feature 参数\n\n## 实践指导\n\n### 常见场景\n\n**场景1：all + 子模块 feature**\n```bash\n# 当前配置\n-f all,comm_pubsub,hotpatch_so\n\n# 分析\n- all 已包含 comm 和 hotpatch\n- comm_pubsub 是 comm 的子模块，不在 all 中\n- hotpatch_so 是 hotpatch 的子模块，不在 all 中\n- 结论：comm_pubsub 和 hotpatch_so 不是冗余的\n```\n\n**场景2：all + 包含在 all 中的 feature**\n```bash\n# 当前配置\n-f all,ushell,tools\n\n# 分析\n- all 已包含 ushell 和 tools\n- 结论：ushell 和 tools 是冗余的\n- 优化后：-f all\n```\n\n**场景3：独立 feature**\n```bash\n# 当前配置\n-f all,time_clock_sync\n\n# 分析\n- time_clock_sync 不在 all 中\n- 结论：time_clock_sync 不是冗余的\n```\n\n### 注意事项\n\n- **Feature 命名规范**：注意 feature 命名可能使用下划线或连字符\n- **条件依赖**：某些 feature 可能在特定条件下启用\n- **测试需求**：测试项目可能需要额外的 feature\n- **平台差异**：不同平台可能需要不同的 feature 组合\n\n## 检查清单\n\n完成检查后，验证以下内容：\n\n- [ ] 已正确解析 Cargo.toml 中的所有 feature 定义\n- [ ] 已正确识别 `all` feature 包含的所有组件\n- [ ] 已检查所有相关的构建脚本文件\n- [ ] 已区分顶层 feature 和子模块 feature\n- [ ] 已验证冗余 feature 是否可以安全移除\n- [ ] 已生成详细的检查报告\n- [ ] 已提供优化建议和风险评估\n- [ ] 已在修改前备份原始文件",
  "scope": "global"
}