{
  "problem_type": "Gerrit 代码走查规则",
  "content": "# Gerrit 代码走查规则\n\n## 规则简介\n本规则描述了使用 Gerrit 进行代码走查的标准流程。通过指定 Gerrit URL，从 URL 中解析出 change-id、repo、branch 等信息，然后使用 oss 工具下载对应的 patch，本地应用 patch 后进行代码审查，最后根据审查结果设置 review 评分。\n\n## 你必须遵守的原则\n\n### 1. URL 解析原则\n\n**要求说明：**\n\n- **必须**：从 Gerrit URL 中正确解析出 change-id、repo、branch 等关键信息\n- **必须**：确保 URL 格式符合 Gerrit 标准格式\n- **必须**：验证解析出的信息的正确性\n\n### 2. Patch 应用原则\n\n**要求说明：**\n\n- **必须**：询问用户本地代码库路径\n- **必须**：切换到对应的分支\n- **必须**：正确应用下载的 patch\n- **必须**：确保代码库状态干净\n\n### 3. 代码审查原则\n\n**要求说明：**\n\n- **必须**：在 repo 根目录进行代码审查\n- **必须**：对发现的问题进行详细记录\n- **必须**：按照代码质量标准进行审查\n- **必须**：使用行评论（Line Comments）或范围评论（Range Comments）提交所有代码问题\n- **禁止**：跳过任何审查步骤\n- **禁止**：仅在总体评论中列出问题而不使用行评论标注\n\n### 4. Review 评分原则\n\n**要求说明：**\n\n- **必须**：根据审查结果正确设置 review 评分\n- **必须**：在发现问题时提供详细的反馈\n- **必须**：在没有问题时也设置 review 表示确认\n\n## 你必须执行的操作\n\n### 操作1：从URL解析Gerrit信息\n\n**执行步骤：**\n\n1. 接收用户提供的Gerrit URL\n2. 解析URL格式，典型的格式如：`https://gerrit-server/gerrit/r/project-name/+/change-id`\n3. 提取以下信息：\n   - change-id：Gerrit中的变更ID\n   - repo：代码仓库名称\n   - branch：目标分支名称\n\n### 操作2：使用git fetch获取patch（推荐）\n\n**执行步骤：**\n\n1. 使用 `oss gerrit get-change-detail` 命令获取变更详细信息\n   ```bash\n   oss gerrit get-change-detail <change-id>\n   ```\n2. 从变更详情中获取当前补丁集信息（patchset number）\n3. 使用 `git fetch` 直接拉取 Gerrit 变更\n   ```bash\n   # 格式：git fetch <remote> refs/changes/<id_part>/<change-id>/<patchset> && git checkout FETCH_HEAD\n   # 示例（change-id=12345, patchset=3）：\n   git fetch origin refs/changes/45/12345/3 && git checkout FETCH_HEAD\n   ```\n\n**优势：**\n- 无需下载patch文件，避免临时文件管理\n- 获取完整的提交信息（作者、时间、提交信息等）\n- 更符合Git工作流，便于后续操作\n\n**回退方法：**\n审查完成后，使用以下命令回退：\n```bash\ngit checkout -\n```\n\n### 操作3：本地环境准备\n\n**执行步骤：**\n\n1. 询问用户本地代码库路径\n2. 切换到对应目录\n3. **检查并更新本地代码到最新版本**（重要！）\n   ```bash\n   git fetch origin && git reset --hard origin/<branch-name>\n   ```\n4. 确保本地分支与变更分支一致\n5. 确保工作区干净（无未提交的修改）\n\n### 操作4：应用patch\n\n**执行步骤：**\n\n1. 执行 `git fetch` 和 `git checkout FETCH_HEAD` 命令\n2. 确保变更成功检出\n3. 检查当前工作目录状态\n   ```bash\n   git status\n   git log --oneline -1  # 确认当前在FETCH_HEAD\n   ```\n4. **审查完成后回退**：\n   ```bash\n   git checkout -  # 回退到之前的分支\n   ```\n\n### 操作5：执行代码审查\n\n**执行步骤：**\n\n1. 切换到 repo 根目录\n2. **保存任务信息到记忆**（便于后续参考）\n3. 执行代码审查（可创建sub任务）\n4. **代码审查维度**：\n   - **正确性**：逻辑是否正确，边界条件是否处理\n   - **安全性**：是否存在安全漏洞（缓冲区溢出、空指针、线程安全等）\n   - **性能**：是否有性能问题（不必要的循环、内存泄漏等）\n   - **可维护性**：代码结构是否清晰，命名是否合理\n   - **代码规范**：是否符合项目编码规范\n   - **测试覆盖**：是否有足够的单元测试\n\n5. **深度分析要求（重要）**：\n   - 对于**非风格类问题**（逻辑问题、安全问题、性能问题等），必须深入分析\n   - **必须读取并理解代码逻辑**，不要仅凭表面现象判断\n   - **必须提供问题触发的具体场景**，包括：\n     * **数据流路径**：说明数据如何从输入传递到问题代码\n     * **控制流路径**：说明执行流程如何到达问题代码\n     * **触发条件**：说明在什么情况下问题会暴露\n   - **示例**：\n     ```\n     问题：静态变量s_ddwLastRecordTime存在线程安全问题\n     \n     分析：\n     - 数据流：GetCpuAlarmIngoreResult() -> RecordCpuAlarmIgnoreInfo()\n     - 控制流：多线程同时调用RecordCpuAlarmIgnoreInfo()\n     - 触发场景：\n       1. 线程A执行RecordCpuAlarmIgnoreInfo()，检查到ddwCurrentRunTime - s_ddwLastRecordTime >= ALARM_IGNORE_RECORD_THRESHOLD\n       2. 线程B同时执行相同检查，也通过阈值检查\n       3. 线程A和B都更新s_ddwLastRecordTime，导致其中一个线程的记录被覆盖\n     ```\n\n6. **强制使用行评论或范围评论（必须执行）**：\n   - **所有代码问题必须使用行评论或范围评论提交**\n   - **行评论优势**：\n     * 精确定位问题代码位置\n     * 开发者更容易理解和修改\n     * 审查意见更加可操作\n   - **行评论使用方法（推荐）**：\n     ```bash\n     # 步骤1：创建评论JSON文件\n     cat > /tmp/review_comments.json << 'EOF'\n     [\n       {\n         \"path\": \"src/comm_linux/interface/source/comminterface.c\",\n         \"line\": 242,\n         \"message\": \"【Jarvis Agent自主评审】[严重] 静态变量bIsFirst存在竞态条件，多线程环境下可能导致判断错误\"\n       },\n       {\n         \"path\": \"src/comm_linux/interface/source/comminterface.c\",\n         \"line\": 245,\n         \"message\": \"【Jarvis Agent自主评审】[严重] 建议使用pthread_once或原子操作确保线程安全\"\n       },\n       {\n         \"path\": \"src/comm_linux/interface/source/comminterface.c\",\n         \"range\": {\n           \"start_line\": 240,\n           \"end_line\": 260\n         },\n         \"message\": \"【Jarvis Agent自主评审】[中等] 整个函数需要重新设计以支持多线程环境\"\n       }\n     ]\n     EOF\n\n     # 步骤2：使用--comments-file参数提交评审\n     oss gerrit set-review <change-id> \\\n       --label Code-Review=-1 \\\n       --message \"【Jarvis Agent自主评审】发现线程安全问题需要修复\" \\\n       --comments-file /tmp/review_comments.json\n     ```\n   - **JSON格式说明**：\n     * 单行评论：`{\"path\": \"文件路径\", \"line\": 行号, \"message\": \"评论内容\"}`\n     * 范围评论：`{\"path\": \"文件路径\", \"range\": {\"start_line\": 起始行, \"end_line\": 结束行}, \"message\": \"评论内容\"}`\n   - **总体评论使用场景**：\n     * 仅用于总结性评价\n     * 必须包含问题列表摘要，明确指出有哪些行评论\n     * 格式：`总体问题见行评论：文件:行号 - 问题描述`\n   - **禁止事项**：\n     * 禁止仅在总体评论中列出问题而不使用行评论\n     * 禁止用模糊描述代替精确的行号定位\n\n### 操作5.5：用户确认（必须执行）\n\n**执行步骤：**\n\n1. **整理问题列表**：将发现的问题按严重程度分类整理\n2. **向用户展示**：以结构化方式展示所有问题，例如：\n   ```\n   【代码审查报告】\n   \n   变更ID: <change-id>\n   修改文件: <file-count> 个\n   发现问题: <total-count> 个\n   \n   === 严重问题 (<count>) ===\n   1. [文件:行号] 问题描述\n   2. [文件:行号] 问题描述\n   \n   === 中等问题 (<count>) ===\n   1. [文件:行号] 问题描述\n   \n   === 低优先级 (<count>) ===\n   1. [文件:行号] 问题描述\n   \n   建议评分: Code-Review=<score>\n   ```\n3. **等待用户确认**：\n   - 询问用户：\"以上问题是否需要修改？请确认评审意见和评分\"\n   - 如果用户要求调整，根据用户反馈修改问题列表或评分\n   - 如果用户要求修改某条意见，更新对应内容\n   - 如果用户要求删除某条意见，从列表中移除\n4. **用户确认后**：才能执行操作6提交评审\n\n**重要**：\n- **禁止**：未经用户确认直接提交评审\n- **必须**：清晰展示所有问题，让用户充分了解\n- **必须**：给用户修改和调整的机会\n\n### 操作6：设置Review\n\n**执行步骤：**\n\n1. 根据审查结果，使用 `oss gerrit set-review` 命令设置评分\n   ```bash\n   # 有严重问题时（阻塞合入）\n   oss gerrit set-review <change-id> --label Code-Review=-2 --message \"发现的问题详细描述\"\n   \n   # 有需要改进的问题（不阻塞合入）\n   oss gerrit set-review <change-id> --label Code-Review=-1 --message \"发现的问题详细描述\"\n   \n   # 没有问题\n   oss gerrit set-review <change-id> --label Code-Review=+1 --message \"LGTM\"\n   \n   # 强烈推荐合入\n   oss gerrit set-review <change-id> --label Code-Review=+2 --message \"Approved\"\n   ```\n2. **评分标准**：\n   **+2 (Looks good to me, approved)**:\n   - 代码质量优秀，无明显问题\n   - 所有评审意见已解决\n   \n   **+1 (Looks good to me, but someone else must approve)**:\n   - 代码质量良好，无严重问题\n   - 建议合入，但需要其他人批准\n   \n   **0 (No score)**:\n   - 尚未完成审查\n   \n   **-1 (This patch needs further work before it can be merged)**:\n   - 发现需要改进的问题\n   - 问题不阻塞合入，但建议修复\n   \n   **-2 (Do not merge)**:\n   - 发现严重问题（安全漏洞、功能缺陷等）\n   - 必须修复后才能合入\n3. **审查意见格式**：\n   - 每条问题前加前缀：【Jarvis Agent自主评审】\n   - 按严重程度分类（严重/中等/低）\n   - 提供具体的改进建议\n4. **行评论提交方式**（优先使用）：\n   ```bash\n   # 方式1：使用--comments-file参数（推荐）\n   oss gerrit set-review <change-id> \\\n     --label Code-Review=-1 \\\n     --message \"总体评价\" \\\n     --comments-file /tmp/review_comments.json\n   \n   # 方式2：如果--comments-file不支持，在message中引用行评论\n   oss gerrit set-review <change-id> \\\n     --label Code-Review=-1 \\\n     --message \"总体评价\n     \n     行评论：\n     - src/file.c:242: 线程安全问题\n     - src/file.c:245: 建议使用原子操作\"\n   ```\n5. 确认 review 设置成功\n6. **保存审查结果到长期记忆**（便于后续参考）\n\n## 检查清单\n\n在执行 Gerrit 代码走查时，必须确认：\n\n- [ ] URL 信息已正确解析\n- [ ] 拥有访问 Gerrit 服务器的权限\n- [ ] 本地代码库路径已获取\n- [ ] 分支已正确切换\n- [ ] Patch 已成功应用\n- [ ] 在 repo 根目录进行代码审查\n- [ ] 审查结果已根据标准记录\n- [ ] **所有代码问题已使用行评论或范围评论标注**\n- [ ] Review 评分已正确设置\n\n## 相关资源\n\n- OSS 工具使用规则：`/home/wangmaobin/.jarvis/rules/oss_utils_usage.md`\n- Gerrit 官方文档",
  "scope": "global"
}