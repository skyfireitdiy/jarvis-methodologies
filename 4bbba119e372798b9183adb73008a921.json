{
  "problem_type": "大模型输出数量限制",
  "content": "## 大模型输出数量限制的双重保障策略\n\n### 问题重述\n在使用大模型时，需要限制其返回结果的数量（如最多10条方法论、最多5个步骤等），以避免返回过多内容导致处理困难或超出系统限制。\n\n### 解决流程\n\n#### 步骤1：在提示词中添加软约束\n在发送给大模型的提示词中，明确说明数量限制要求：\n```\n请分析需求，选择相关性较高的内容（最多选择X条）。\n```\n\n**要点**：\n- 使用明确的语言：\"最多选择X条\"、\"限制在X条以内\"\n- 放在核心要求之前或紧接着核心要求\n- 可以配合示例说明\n\n#### 步骤2：在代码中添加硬约束（双重保障）\n即使提示词中已有限制，也必须在代码层面实现硬性约束：\n\n```python\n# 示例：在循环中检查数量\nfor item in selected_items:\n    # 检查是否已达到数量限制\n    if selected_count >= max_limit:\n        print(f\"已达到数量限制 ({selected_count}/{max_limit})\")\n        break\n   \n    # 处理当前项\n    selected_count += 1\n```\n\n**要点**：\n- 数量限制放在其他限制（如token限制）之前优先检查\n- 添加清晰的日志输出，便于调试和监控\n- 处理边界情况（如正好达到限制、超过限制）\n\n#### 步骤3：处理大模型返回结果\n即使有双重保障，仍需处理大模型可能返回超过限制的情况：\n\n```python\n# 解析大模型返回的序号或列表\nindices = parse_indices(response)\n\n# 代码层面再次截断\nindices = indices[:max_limit]\n```\n\n### 注意事项\n\n1. **软约束与硬约束配合**：提示词是软约束，代码是硬约束，两者缺一不可\n2. **提示词优先**：优先让大模型自我约束，减少代码截断带来的信息损失\n3. **清晰反馈**：达到限制时输出清晰的日志，便于用户了解情况\n4. **可配置性**：将限制值作为参数或配置，便于后续调整\n\n### 可选步骤\n\n1. **动态调整限制**：根据token预算、任务复杂度等因素动态调整限制值\n2. **优先级排序**：让大模型对结果按相关性排序，确保截断时保留最重要的内容\n3. **渐进式加载**：对于超量结果，分批次加载或询问用户是否继续\n\n### 适用场景\n\n- 方法论选择与加载\n- 代码重构建议生成\n- 测试用例生成\n- 任何需要限制大模型返回数量的场景\n\n### 最佳实践\n\n- 始终采用\"提示词 + 代码\"的双重保障策略\n- 在提示词中使用\"最多X条\"的明确表述\n- 代码中的硬限制应与提示词中的软限制保持一致\n- 添加适当的日志和监控机制",
  "scope": "global"
}