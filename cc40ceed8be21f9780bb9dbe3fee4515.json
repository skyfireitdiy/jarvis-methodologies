{
  "problem_type": "Rust测试间状态污染排查",
  "content": "# Rust测试间状态污染排查方法\n\n## 问题重述\n当Rust项目使用全局状态（如Atomic变量、静态变量）时，测试间可能出现状态污染，导致：\n- 单独运行测试通过，批量运行失败\n- 测试顺序影响结果\n- 原子操作返回值与预期不符\n\n## 可复用解决流程\n\n### 步骤1：识别状态污染源\n```bash\n# 查找全局状态变量\nrg \"static.*mut\\|Atomic\\|lazy_static\\|once_cell\" src/\nrg \"DEPTH\\|COUNTER\\|STATE\" src/\n```\n\n### 步骤2：验证状态重置机制\n1. 检查是否存在reset_xxx函数\n2. 验证reset函数是否完全重置所有相关状态\n3. 确认测试开始前是否调用reset函数\n\n### 步骤3：测试隔离验证\n```bash\n# 单独运行失败的测试\ncargo test test_name -- --nocapture\n# 指定测试顺序运行\ncargo test -- --test-threads=1 --nocapture\n```\n\n### 步骤4：修复策略\n1. **添加reset函数**：确保每个使用全局状态的模块提供reset函数\n2. **测试初始化**：在测试开始前调用reset函数\n3. **状态隔离**：考虑使用线程局部存储或测试专用实例\n4. **Atomic操作验证**：确认fetch_add/fetch_sub返回值是否正确处理\n\n### 步骤5：回归验证\n```bash\n# 运行完整测试套件\ncargo test -- --nocapture\n# 验证无状态污染\nfor i in {1..10}; do cargo test -- --nocapture; done\n```\n\n## 注意事项\n- 特别关注Atomic操作：fetch_add返回旧值，需要+1得到新值\n- 检查Mutex/RwLock是否正确处理poison错误\n- 验证临时文件和全局列表是否正确清理\n\n## 可选步骤\n- 使用#[serial]属性强制测试串行执行\n- 实现Drop trait自动清理状态\n- 添加测试运行前后的钩子函数"
}