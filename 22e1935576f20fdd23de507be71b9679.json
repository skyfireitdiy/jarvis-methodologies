{
  "problem_type": "远程服务器信息采集",
  "content": "# 远程服务器信息采集方法论\n\n## 规则简介\n\n本方法论提供了一套标准的远程服务器信息采集流程，适用于需要通过SSH登录远程系统并采集系统信息、进程信息、日志文件等数据的场景。特别适用于多层网络架构下的数据采集任务。\n\n## 你必须遵守的原则\n\n### 数据完整性原则\n\n**要求说明：**\n\n- **必须**：确保采集的数据完整无误，采集后必须验证文件大小和内容\n- **必须**：对重要数据文件进行头部和尾部检查，确认数据未截断\n- **禁止**：未经验证就认为数据采集完成\n\n### 安全操作原则\n\n**要求说明：**\n\n- **必须**：先在测试环境验证采集命令，避免在生产环境执行未知命令\n- **必须**：只采集只读数据（如/proc、日志文件），禁止修改生产环境数据\n- **禁止**：停止、删除或重启关键进程\n- **禁止**：执行未经验证的写入操作\n\n### 会话管理原则\n\n**要求说明：**\n\n- **必须**：使用持久会话工具（如virtual_tty）保持连接状态\n- **必须**：处理SSH密钥冲突等常见连接问题\n- **必须**：记录每个操作步骤的输出，便于问题排查\n\n## 你必须执行的操作\n\n### 阶段1：准备工作\n\n1. **确认环境信息**：\n   - 明确目标服务器的IP地址、用户名、密码\n   - 了解网络拓扑（如是否需要跳板机、主控板等中间节点）\n   - 确认目标进程名称或文件路径\n\n2. **验证采集命令**：\n   - 在测试环境验证要执行的命令\n   - 确认命令参数正确，不会产生副作用\n   - 评估数据文件大小，确保有足够存储空间\n\n### 阶段2：建立连接\n\n1. **创建持久会话**：\n   - 使用`virtual_tty launch`创建持久SSH会话\n   - 为会话指定有意义的tty_id，便于管理\n\n2. **处理连接问题**：\n   - 如遇到\"WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED\"，使用`ssh-keygen -R`清除旧密钥\n   - 等待密码提示，通过`send_keys`发送密码\n   - 确认成功登录后再执行下一步\n\n3. **多层登录**：\n   - 如果需要通过中间节点（如主控板）登录目标服务器\n   - 先登录中间节点，再从中间节点SSH到目标服务器\n   - 注意不同层级可能使用不同的用户名和密码\n\n### 阶段3：信息采集\n\n1. **定位目标**：\n   - 进程信息：使用`ps aux | grep <进程名>`查找PID\n   - 文件位置：使用`find`或`locate`定位目标文件\n   - 记录关键标识符（如PID、文件路径）\n\n2. **执行采集命令**：\n   - 进程内存信息：`cat /proc/<PID>/status > /tmp/<文件名>.txt`\n   - 进程内存映射：`cat /proc/<PID>/smaps > /tmp/<文件名>.txt`\n   - 日志文件：`cat <日志路径> > /tmp/<文件名>.txt`\n   - 系统信息：根据需求使用相应的命令（如top、vmstat等）\n\n3. **等待完成**：\n   - 大文件采集需要时间，耐心等待命令执行完成\n   - 确认提示符返回后再进行下一步操作\n\n### 阶段4：数据验证\n\n1. **检查文件生成**：\n   - 使用`ls -lh /tmp/<文件名>*`确认文件已生成\n   - 检查文件大小是否合理（不为0，不是异常小）\n\n2. **验证内容完整性**：\n   - 使用`head -n 20`查看文件头部，确认数据格式正确\n   - 使用`tail -n 20`查看文件尾部，确认数据未截断\n   - 对比预期数据量，确认采集完整\n\n3. **记录关键信息**：\n   - 记录采集时间、服务器信息、进程PID等元数据\n   - 保存验证结果，便于后续分析\n\n### 阶段5：数据传输（如需要）\n\n1. **评估传输方式**：\n   - 检查目标服务器是否支持scp命令\n   - 如果不支持scp，使用sftp进行文件传输\n\n2. **多层网络传输**：\n   - 如果目标服务器无法直接访问本地，需要通过中间节点转发\n   - 典型流程：目标服务器 --[sftp put]--> 中间节点 --[sftp get]--> 本地\n\n3. **验证传输结果**：\n   - 传输后使用`ls -lh`确认本地文件已生成\n   - 对比源文件和目标文件大小，确保传输完整\n\n### 阶段6：清理和关闭\n\n1. **清理临时文件**：\n   - 确认本地数据完整后，询问是否需要清理远程临时文件\n   - 如需清理，使用`rm /tmp/<临时文件>`删除\n\n2. **关闭会话**：\n   - 使用`exit`退出远程服务器\n   - 使用`virtual_tty close`关闭持久会话\n   - 确认所有连接已正确关闭\n\n## 实践指导\n\n### 常见命令示例\n\n**进程信息采集**：\n   ```bash\n# 查找进程\nps aux | grep <进程名>\n\n# 采集status\ncat /proc/<PID>/status > /tmp/status.txt\n\n# 采集smaps\ncat /proc/<PID>/smaps > /tmp/smaps.txt\n\n# 采集fd信息\nls -l /proc/<PID>/fd > /tmp/fd.txt\n```\n\n**日志文件采集**：\n   ```bash\n# 完整日志\ncat /var/log/<应用>.log > /tmp/app.log\n\n# 最近N行\ntail -n 1000 /var/log/<应用>.log > /tmp/app_last1000.log\n\n# 按时间范围\nsed -n '/2026-02-02 10:00/,/2026-02-02 11:00/p' /var/log/<应用>.log > /tmp/app_range.log\n```\n\n### virtual_tty工具使用技巧\n\n1. **会话创建**：\n   ```bash\n   virtual_tty launch --tty-id <会话ID>\n```\n\n2. **发送命令**：\n   ```bash\n   virtual_tty send_keys --tty-id <会话ID> --keys \"<命令>\" --add-enter true\n```\n\n3. **获取输出**：\n   ```bash\n   virtual_tty output --tty-id <会话ID> --timeout 5.0\n```\n\n4. **关闭会话**：\n   ```bash\n   virtual_tty close --tty-id <会话ID>\n```\n\n### 故障排查\n\n**SSH密钥冲突**：\n```\nWARNING: REMOTE HOST IDENTIFICATION HAS CHANGED\n解决：ssh-keygen -f ~/.ssh/known_hosts -R <IP地址>\n```\n\n**密码输入失败**：\n- 确认密码末尾是否需要特殊字符（如$）\n- 等待密码提示完全出现后再输入\n- 检查是否有大写锁定或特殊字符输入问题\n\n**文件未生成**：\n- 检查目录权限：`ls -ld /tmp`\n- 检查磁盘空间：`df -h`\n- 检查进程是否存在：`ps aux | grep <PID>`\n\n**数据截断**：\n- 检查文件大小是否异常\n- 使用tail查看文件尾部，确认有完整结束标记\n- 重新采集，等待命令完全执行完成\n\n## 检查清单\n\n### 采集前检查\n\n- [ ] 确认目标服务器IP、用户名、密码\n- [ ] 了解网络拓扑和登录路径\n- [ ] 验证采集命令在测试环境可用\n- [ ] 确认有足够的存储空间\n\n### 采集过程检查\n\n- [ ] 成功创建并连接持久会话\n- [ ] 处理了SSH密钥冲突（如有）\n- [ ] 成功登录目标服务器\n- [ ] 找到目标进程或文件\n- [ ] 采集命令执行无错误\n- [ ] 等待命令完全执行完成\n\n### 采集后验证\n\n- [ ] 文件已生成在目标位置\n- [ ] 文件大小合理（不为0，不是异常小）\n- [ ] 文件头部内容格式正确\n- [ ] 文件尾部内容完整未截断\n- [ ] 记录了采集时间和元数据\n\n### 传输验证（如需要）\n\n- [ ] 文件成功传输到本地\n- [ ] 本地文件大小与远程一致\n- [ ] 本地文件内容可正常读取\n- [ ] 远程临时文件已清理（如需要）",
  "scope": "global"
}