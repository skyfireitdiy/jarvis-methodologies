{
  "problem_type": "Python模块拆分重构",
  "content": "# Python模块拆分重构方法论\n\n## 规则简介\n\n本方法论提供了Python模块拆分重构的标准化流程，用于将大型、复杂的Python模块拆分为多个小型、职责单一的模块。通过AST分析、依赖聚类和自动化工具，实现安全、可控的模块拆分，提升代码的可维护性和可扩展性。\n\n适用场景：\n- 单个模块文件超过500行\n- 模块包含多个不相关的功能领域\n- 模块之间存在复杂的依赖关系\n- 需要提升代码的组织结构和可维护性\n\n## 你必须遵守的原则\n\n### 原则1：保守拆分原则\n\n**要求说明：**\n\n- **必须**：优先拆分具有强相互依赖的组件组（≥2个组件）\n- **必须**：避免过度拆分导致模块碎片化\n- **必须**：保持业务逻辑的完整性，不破坏功能内聚\n- **禁止**：将紧密相关的类/函数拆分到不同模块\n\n### 原则2：依赖关系最小化原则\n\n**要求说明：**\n\n- **必须**：拆分后模块间的依赖关系应尽可能简单\n- **必须**：优先拆分依赖关系清晰的组件组\n- **必须**：避免循环依赖\n- **禁止**：创建复杂的跨模块依赖网络\n\n### 原则3：安全可回退原则\n\n**要求说明：**\n\n- **必须**：使用版本控制，每次拆分前创建提交点\n- **必须**：集成FixHistory或类似机制，支持回滚\n- **必须**：拆分后运行完整测试套件验证功能\n- **禁止**：在没有测试覆盖的情况下进行大规模拆分\n\n### 原则4：命名规范性原则\n\n**要求说明：**\n\n- **必须**：使用清晰的命名约定（如{原模块名}_part{序号}）\n- **必须**：保持命名与模块职责一致\n- **必须**：更新所有import语句\n- **禁止**：使用模糊或误导性的模块名称\n\n## 你必须执行的操作\n\n### 阶段1：分析与评估\n\n1. **评估拆分必要性**：\n   - 检查模块行数（超过500行建议拆分）\n   - 识别模块中的功能领域\n   - 评估组件数量（类、函数的总数）\n   - 判断是否存在代码异味（过长类、职责不清等）\n\n2. **AST依赖分析**：\n   - 使用ast模块解析Python代码\n   - 构建组件依赖图（类/函数的依赖关系）\n   - 计算圈复杂度\n   - 识别依赖方向（谁依赖谁）\n\n3. **聚类分析**：\n   - 使用图遍历算法（BFS/DFS）识别强连通分量\n   - 找出互相依赖的组件簇\n   - 评估每个聚类的内聚度和耦合度\n   - 确定可拆分的组件组（≥2个组件的强依赖组）\n\n### 阶段2：设计拆分方案\n\n1. **制定拆分计划**：\n   - 确定拆分后的模块数量\n   - 为每个新模块分配组件\n   - 设计模块命名方案\n   - 规划import语句更新\n\n2. **风险评估**：\n   - 识别可能受影响的代码\n   - 评估拆分对现有功能的影响\n   - 制定缓解措施（如更新import、调整依赖）\n   - 确保测试覆盖充分\n\n3. **创建拆分计划文档**：\n   - 列出原模块中的所有组件\n   - 标注每个组件的目标模块\n   - 说明拆分理由和预期收益\n   - 记录风险和缓解措施\n\n### 阶段3：执行拆分\n\n1. **准备工作**：\n   - 确保所有测试通过\n   - 创建版本控制提交点\n   - 备份原始模块文件\n\n2. **创建新模块**：\n   - 按照拆分计划创建新模块文件\n   - 将对应的类/函数移动到新模块\n   - 保持原有代码格式和文档字符串\n   - 添加必要的import语句\n\n3. **修改原模块**：\n   - 从原模块中移除已拆分的组件\n   - 添加import语句引用新模块\n   - 确保原模块的公共接口保持兼容\n   - 更新文档字符串\n\n4. **更新依赖方**：\n   - 查找所有引用原模块的代码\n   - 根据需要更新import语句\n   - 确保没有遗漏的引用\n\n### 阶段4：验证与优化\n\n1. **运行测试套件**：\n   - 执行所有单元测试\n   - 执行集成测试\n   - 验证功能行为未改变\n   - 检查测试覆盖率\n\n2. **静态检查**：\n   - 运行ruff进行代码风格检查\n   - 运行mypy进行类型检查\n   - 修复所有警告和错误\n   - 确保代码质量标准\n\n3. **性能验证**：\n   - 对比重构前后的性能\n   - 检查是否有性能回归\n   - 如有必要，进行性能优化\n\n4. **文档更新**：\n   - 更新模块文档\n   - 更新API文档\n   - 记录拆分决策和变更\n   - 通知团队成员\n\n## 实践指导\n\n### 最佳实践\n\n1. **使用自动化工具**：\n   - 优先使用SplitModuleRefactorer等自动化工具\n   - 工具可以减少人为错误，提高效率\n   - 确保工具支持FixHistory集成\n\n2. **渐进式拆分**：\n   - 不要一次性拆分太多组件\n   - 每次拆分后立即测试验证\n   - 逐步迭代，确保每一步都安全可控\n\n3. **保持向后兼容**：\n   - 在原模块中保留公共接口的导出\n   - 使用`from new_module import SomeClass`保持兼容\n   - 给用户适应新结构的时间\n\n4. **团队协作**：\n   - 拆分前与团队沟通计划\n   - 代码审查确保拆分合理性\n   - 及时更新团队文档和规范\n\n### 常见错误与注意事项\n\n1. **过度拆分**：\n   - 避免将小模块拆分得更小\n   - 保持合理的模块粒度（建议≥100行）\n\n2. **忽略import更新**：\n   - 确保所有import语句正确更新\n   - 检查测试文件中的import\n   - 检查文档中的示例代码\n\n3. **破坏功能内聚**：\n   - 不要将紧密相关的组件拆分\n   - 保持业务逻辑的完整性\n   - 避免跨模块的频繁调用\n\n4. **缺少测试**：\n   - 确保有充分的测试覆盖\n   - 拆分前后测试结果必须一致\n   - 不要在没有测试的情况下拆分\n\n## 检查清单\n\n完成模块拆分后，必须确认：\n\n- [ ] 所有测试通过（拆分前后测试结果一致）\n- [ ] 静态检查通过（ruff、mypy无错误）\n- [ ] 模块职责清晰，命名合理\n- [ ] 依赖关系简洁，无循环依赖\n- [ ] import语句正确更新\n- [ ] 文档已更新\n- [ ] 性能无明显下降\n- [ ] 版本控制提交完成\n- [ ] FixHistory记录已保存\n- [ ] 团队已通知（如涉及公共接口）",
  "scope": "global"
}