{
  "problem_type": "Rust项目批量依赖重构",
  "content": "# Rust项目批量依赖重构方法论\n\n## 问题场景\n需要将多个Rust crate从路径依赖转为动态链接库依赖，涉及：\n- 统一添加build.rs构建脚本\n- 批量移除Cargo.toml中的路径依赖\n- 统一添加extern crate声明\n- 保持现有功能不破坏\n\n## 标准化解决流程\n\n### 步骤1：项目状态分析\n使用工具批量分析crate状态：\n   ```bash\n# 统计需要处理的crate\nfind benchmark/ manual_test/ -name \"Cargo.toml\" | wc -l\n\n# 检查现有build.rs文件\nfind benchmark/ manual_test/ -name \"build.rs\" | sort\n\n# 分析依赖形式\ngrep -r \"idf.*path\" */Cargo.toml\n   ```\n\n### 步骤2：制定变更计划\n基于分析结果创建变更清单：\n- 需要拷贝build.rs的crate列表\n- 已有build.rs需要跳过的crate\n- 需要删除的依赖模式（idf和idf-macro）\n- 需要添加extern crate的源文件\n\n### 步骤3：执行批量变更\n1. **拷贝build.rs**（仅目标位置不存在时）：\n   ```bash\n   for crate in $CRATE_LIST; do\n     if [ ! -f \"$crate/build.rs\" ]; then\n       cp demo/build.rs \"$crate/build.rs\"\n     fi\n   done\n   ```\n\n2. **清理Cargo.toml依赖**：\n   ```bash\n   # 删除idf依赖\n   sed -i '/idf.*path.*idf/d' */Cargo.toml\n   # 删除idf-macro依赖\n   sed -i '/idf-macro.*path.*idf-macro/d' */Cargo.toml\n   ```\n\n3. **添加extern crate声明**：\n   ```bash\n   for main_file in */src/main.rs; do\n     if ! grep -q \"extern crate idf\" \"$main_file\"; then\n       sed -i '1iextern crate idf;' \"$main_file\"\n     fi\n   done\n   ```\n\n### 步骤4：验证变更结果\n1. **文件层面验证**：\n   ```bash\n   # 确认build.rs存在且内容正确\n   find benchmark/ manual_test/ -name \"build.rs\" -exec wc -l {} \\;\n  \n   # 确认依赖已删除\n   ! grep -r \"idf.*path\" */Cargo.toml\n  \n   # 确认extern crate已添加\n   grep -r \"extern crate idf\" */src/main.rs\n   ```\n\n2. **语法验证**：\n   ```bash\n   # 检查语法正确性（忽略编译错误）\n   cargo check --quiet || true\n   ```\n\n## 关键注意事项\n1. **绝不覆盖已有文件**：使用存在性检查避免覆盖已有build.rs\n2. **精确匹配删除**：使用完整路径模式匹配，避免误删其他依赖\n3. **防止重复添加**：在添加extern crate前先检查是否已存在\n4. **保持备份**：建议先提交git变更，便于回滚\n\n## 适用于\n- 大规模Rust项目重构\n- 从路径依赖转向动态链接\n- 统一项目构建配置\n- 批量crate标准化改造"
}