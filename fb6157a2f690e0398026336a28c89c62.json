{
  "problem_type": "C到Rust静态函数移植测试策略",
  "content": "# C静态函数到Rust移植的TDD测试策略\n\n## 问题重述\n当C静态函数包含静态变量（如计数器）时，移植到Rust后的测试用例会因状态共享而相互影响，导致测试不稳定。\n\n## 可复用解决流程\n\n### 阶段1：分析阶段\n1. 使用`read_code`读取C源码，识别静态变量使用场景\n2. 分析静态变量的生命周期和作用域要求\n\n### 阶段2：测试设计（Red阶段）\n1. 设计测试用例时避免依赖绝对状态值\n2. 转而验证相对关系和递增性\n3. 设计步骤：\n   - 获取当前状态值作为基准\n   - 验证后续调用的递增性\n   - 避免验证具体数值\n\n### 阶段3：实现（Green阶段）\n1. 使用`std::sync::atomic`实现线程安全的静态变量\n2. 对于非原子类型，考虑使用`once_cell`或`lazy_static`\n3. 保持函数签名与C兼容\n\n### 阶段4：测试修复（Refactor阶段）\n1. 当测试因状态共享失败时：\n   - 不要删除测试用例\n   - 调整测试断言逻辑\n   - 验证行为模式而非具体值\n\n## 注意事项\n- 原子类型选择：`AtomicU32`适用于计数器，`AtomicBool`适用于标志\n- 内存排序选择：计数器场景使用`Ordering::Relaxed`即可\n- 测试隔离：无法完全隔离时，采用相对验证策略\n\n## 可选步骤\n- 如需重置状态，可在测试中使用`static mut`配合`unsafe`（不推荐）\n- 考虑使用测试fixture或setup函数管理初始状态"
}