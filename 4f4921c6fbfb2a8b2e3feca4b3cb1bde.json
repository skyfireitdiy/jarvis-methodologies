{
  "problem_type": "规则库分离重构",
  "content": "# 规则库分离重构方法论\n\n## 问题重述\n\n当大型模块中存在大量正则表达式规则、模式匹配规则与业务逻辑耦合在一起时，导致：\n1. 代码臃肿，难以维护\n2. 新增规则需要修改主文件\n3. 规则无法独立管理和测试\n4. 违反单一职责原则\n\n需要将规则库分离到独立模块，实现规则与逻辑解耦。\n\n## 可复用解决流程\n\n### 第一步：分析阶段\n\n1. **识别规则库位置**\n   - 使用搜索工具定位所有正则表达式定义\n   - 统计规则数量和行数\n   - 识别规则引用位置\n\n2. **分析规则类别**\n   - 按功能/职责对规则进行分组\n   - 识别规则之间的关联关系\n   - 确定规则的使用频率和重要性\n\n3. **识别耦合点**\n   - 找出所有直接引用规则的位置\n   - 分析规则与检查逻辑的交互方式\n   - 确定需要保持的公共接口\n\n### 第二步：设计阶段\n\n1. **规则库模块设计**\n   - 设计新模块的文件位置（如：xxx_rules.py）\n   - 按类别组织规则类（如：BaseRules, FormatRules, ThreadRules）\n   - 定义清晰的类名和属性名\n\n2. **接口定义**\n   - 定义规则类的公共接口（通常是静态属性）\n   - 确保所有规则都已编译（使用 re.compile）\n   - 设计导入方式（推荐按类导入）\n\n3. **迁移路径规划**\n   - 制定逐步迁移计划（按类别逐批替换）\n   - 规划验证步骤（每批替换后验证）\n   - 确定测试策略\n\n### 第三步：实施阶段\n\n1. **创建规则库文件**\n   - 创建新规则模块文件\n   - 按类别组织规则类\n   - 迁移所有正则表达式定义\n   - 添加必要的文档和注释\n\n2. **修改主模块导入**\n   - 在主模块顶部添加导入语句\n   - 导入所有规则类\n   - 确保导入顺序正确\n\n3. **替换规则引用**\n   - 逐类替换规则引用（如：RE_RULE → BaseRules.RE_RULE）\n   - 每替换一类，验证一次\n   - 保持代码风格一致\n\n4. **清理冗余代码**\n   - 删除主模块中的规则定义\n   - 清理相关注释\n   - 确保无遗留代码\n\n### 第四步：验证阶段\n\n1. **功能验证**\n   - 运行完整测试套件\n   - 对比重构前后输出一致性\n   - 验证所有规则正常工作\n\n2. **代码质量检查**\n   - 确认代码行数减少\n   - 检查代码风格一致性\n   - 验证模块职责清晰\n\n3. **文档更新**\n   - 更新相关文档\n   - 添加规则库说明\n   - 更新 API 文档\n\n## 注意事项\n\n1. **保持功能不变**\n   - 所有规则的正则表达式必须完全一致\n   - 不得改变规则标志（如 re.IGNORECASE）\n   - 保持原有的错误处理逻辑\n\n2. **小步快跑**\n   - 按类别逐批替换，每批验证\n   - 避免一次性大规模修改\n   - 保留回退能力\n\n3. **测试驱动**\n   - 在重构前确保测试覆盖充分\n   - 每批替换后立即测试\n   - 对比重构前后输出\n\n4. **文档同步**\n   - Spec 文档在重构前编写完成\n   - 代码变更后同步更新文档\n   - 保持文档与代码一致\n\n## 可选步骤\n\n### 进阶优化（重构完成后）\n\n1. **规则配置化**\n   - 支持从外部文件加载规则（YAML/JSON）\n   - 实现规则的启用/禁用机制\n   - 支持规则优先级调整\n\n2. **规则测试框架**\n   - 为每个规则编写单元测试\n   - 建立规则测试用例库\n   - 支持规则性能测试\n\n3. **规则验证工具**\n   - 开发规则验证脚本\n   - 检查规则语法正确性\n   - 验证规则覆盖率\n\n## 验收标准\n\n1. **规则库文件验收**\n   - 规则库文件已创建\n   - 所有规则已迁移\n   - 规则按类别组织清晰\n   - 文档完整\n\n2. **功能一致性验收**\n   - 所有测试通过\n   - 重构前后输出一致\n   - 公共接口未改变\n\n3. **代码质量验收**\n   - 主模块代码行数减少\n   - 规则与逻辑完全解耦\n   - 代码风格一致\n\n4. **扩展性验收**\n   - 新增规则只需修改规则库\n   - 规则类结构清晰\n   - 易于理解和维护\n\n## 适用场景\n\n- 代码检查器（如 c_checker）\n- 规则引擎\n- 模式匹配系统\n- 验证器/校验器\n- 日志分析器\n- 任何包含大量正则表达式的模块",
  "scope": "global"
}