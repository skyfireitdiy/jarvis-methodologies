{
  "problem_type": "代码版本内存对比分析",
  "content": "# 代码版本内存对比分析\n\n## 规则简介\n\n该方法论用于对比分析不同代码版本的内存使用差异，通过控制变量法验证代码改动对内存的影响。适用于性能优化、内存泄漏排查、实现方案评估等场景。\n\n## 你必须遵守的原则\n\n### 环境隔离原则\n\n**要求说明：**\n\n- **必须**：每次测试前清理旧的编译产物和运行进程\n- **必须**：确保不同版本使用相同的编译参数和运行环境\n- **禁止**：在测试过程中修改系统配置或其他影响内存的因素\n- **禁止**：同时运行多个版本的程序进行对比\n\n### 数据采集完整性原则\n\n**要求说明：**\n\n- **必须**：采集完整的内存信息（/proc/<PID>/status 和 /proc/<PID>/smaps）\n- **必须**：在程序稳定运行状态（非启动初始化阶段）采集内存\n- **必须**：保存原始数据文件，便于后续详细分析\n- **禁止**：仅采集部分内存指标（如只看VmRSS）\n\n### 版本可追溯原则\n\n**要求说明：**\n\n- **必须**：记录每个测试版本对应的代码commit或分支\n- **必须**：保存完整的代码差异信息\n- **必须**：记录编译参数和运行环境信息\n- **禁止**：测试后无法重现测试环境\n\n## 你必须执行的操作\n\n### 第一阶段：版本准备\n\n1. **识别目标版本**：明确需要对比的代码版本（如commit hash、分支名）\n2. **准备测试脚本**：创建自动化脚本包含版本切换、编译、运行、采集内存的完整流程\n3. **验证环境一致性**：确认系统负载、可用内存等环境因素在可接受范围内\n\n### 第二阶段：旧版本测试\n\n1. **切换到旧版本**：使用 git checkout 切换到目标commit\n2. **清理编译产物**：cargo clean 或 make clean（避免交叉污染）\n3. **编译程序**：使用固定参数编译（如 --release）\n4. **运行并采集内存**：\n   - 启动程序并获取PID\n   - 采集 /proc/<PID>/status > version_old_status.txt\n   - 采集 /proc/<PID>/smaps > version_old_smaps.txt\n5. **验证数据完整性**：检查文件大小和关键指标是否合理\n\n### 第三阶段：新版本测试\n\n1. **切换到新版本**：使用 git checkout 切换到新版本commit\n2. **重复编译运行**：使用与旧版本相同的编译和运行参数\n3. **采集内存数据**：保存为 version_new_status.txt 和 version_new_smaps.txt\n4. **验证数据完整性**\n\n### 第四阶段：对比分析\n\n1. **提取关键指标**：从status文件中提取 VmSize、VmRSS、RssAnon、VmPeak等\n2. **统计Private_Dirty**：从smaps文件中汇总 Private_Dirty 总和\n3. **分析内存映射**：对比不同版本的内存映射段数量和大小分布\n4. **识别异常段**：查找特别大的匿名映射段（可能表示栈或堆异常增长）\n5. **生成对比报告**：记录差异和可能的根因\n\n## 实践指导\n\n### 采集时机选择\n\n- 对于短生命周期程序，在程序启动后稳定运行时采集（如sleep 0.5秒后）\n- 对于长生命周期程序，在业务高峰期或稳定运行一段时间后采集\n- 避免在程序初始化阶段采集（此时内存可能不稳定）\n\n### 关键内存指标含义\n\n- **VmSize**: 虚拟内存大小，包含所有映射的虚拟地址空间\n- **VmRSS**: 实际驻留物理内存，反映真实内存占用\n- **RssAnon**: 匿名映射占用的物理内存（堆、栈等）\n- **Private_Dirty**: 进程私有的脏页，无法与其他进程共享，完全计入物理内存\n\n### 常见问题排查\n\n- 如果VmRSS差异很大，检查是否有内存泄漏（堆持续增长）\n- 如果发现超大栈段（>8MB），检查是否有深层次递归或栈上大对象\n- 如果Private_Dirty差异显著，分析smaps中具体哪些段的Private_Dirty增长\n\n## 检查清单\n\n- [ ] 识别并记录两个对比版本的commit或分支\n- [ ] 两个版本使用相同的编译参数\n- [ ] 两个版本在相似的运行环境下测试\n- [ ] 成功采集旧版本的status和smaps文件\n- [ ] 成功采集新版本的status和smaps文件\n- [ ] 提取并对比关键内存指标（VmSize、VmRSS、RssAnon等）\n- [ ] 汇总Private_Dirty并识别主要增长来源\n- [ ] 生成对比分析报告，明确指出内存差异和可能根因\n- [ ] 代码改动和内存差异建立关联",
  "scope": "global"
}