{
  "problem_type": "Rust并发测试失败排查",
  "content": "## 问题重述\nRust测试套件在并行执行时出现测试失败，但单个测试运行时通过。这类问题通常由共享全局状态（如静态变量、文件系统、环境变量）的并发访问引起。\n\n## 可复用解决流程\n1. **症状识别**\n   - 使用命令：`cargo test` 失败，但 `cargo test <test_name>` 成功\n   - 错误信息通常涉及断言失败，期望值与实际值不符\n\n2. **快速验证**\n   - 运行单个测试：`cargo test -- --nocapture <test_name>`\n   - 确认是否是并发问题：`cargo test -- --test-threads=1`\n   - 如果是线程问题，单线程运行会通过\n\n3. **定位共享资源**\n   - 搜索静态变量：`rg 'static.*mut' src/`\n   - 检查全局状态：`rg 'static.*atomic' src/` 或 `rg 'static.*Mutex' src/`\n   - 查看测试用例是否修改共享状态\n\n4. **解决方案选择**\n   - **方案A：串行化测试**（适用于测试间隔离）\n     - 添加全局锁：`use std::sync::Mutex;`\n     - 定义：`static TEST_LOCK: Mutex<()> = Mutex::new(());`\n     - 在每个测试开头：`let _lock = TEST_LOCK.lock().unwrap();`\n  \n   - **方案B：重置状态**（适用于状态可重置）\n     - 提供重置函数：`fn reset_state() { STATE.store(0, Ordering::Relaxed); }`\n     - 在每个测试开头调用重置函数\n  \n   - **方案C：隔离测试数据**（适用于文件/网络资源）\n     - 为每个测试创建独立临时文件/目录\n     - 使用`tempfile`crate或`std::env::temp_dir()`\n\n5. **验证修复**\n   - 运行完整测试：`cargo test`\n   - 多线程验证：`cargo test -- --test-threads=8`\n   - CI环境验证\n\n## 注意事项\n- 最小化锁范围，仅在必要时加锁\n- 避免在测试中使用`#[ignore]`跳过并发问题\n- 考虑使用`once_cell`或`lazy_static`管理初始化\n- 对于性能敏感测试，优先选择状态隔离而非串行化\n\n## 可选步骤\n- 添加调试输出：在关键位置使用`dbg!()`或`println!()`\n- 使用`loom`crate测试并发正确性\n- 设置`RUST_BACKTRACE=1`获取详细堆栈信息"
}