{
  "problem_type": "API变更审查",
  "content": "# API变更审查方法论\n\n## 规则简介\n\n本方法论提供系统化的API变更审查框架，帮助评估API变更对系统的影响，包括兼容性、调用点、数据流和潜在风险。适用于函数签名变更、结构体字段修改、参数增删等场景。\n\n## 你必须遵守的原则\n\n### 完整性原则\n\n**要求说明：**\n\n- **必须**：追踪从API定义到所有调用点的完整数据流\n- **必须**：评估变更对直接和间接调用方的影响\n- **禁止**：仅基于表面代码进行判断，必须深入理解上下文\n\n### 兼容性优先原则\n\n**要求说明：**\n\n- **必须**：评估API变更对二进制兼容性的影响\n- **必须**：检查是否有外部模块或动态加载依赖此API\n- **禁止**：忽视结构体字段位置变化可能引发的兼容性问题\n\n### 验证充分性原则\n\n**要求说明：**\n\n- **必须**：检查新参数是否有适当的范围校验\n- **必须**：确认错误处理机制是否完善\n- **禁止**：假设调用方总是会传递合法参数\n\n## 你必须执行的操作\n\n### 阶段1：变更识别\n\n1. **识别API变更类型**：\n   - 函数签名变更（新增/删除/修改参数）\n   - 结构体字段变更（新增/删除/修改/重排序）\n   - 返回值类型变更\n   - 宏定义或常量变更\n\n2. **获取变更上下文**：\n   - 使用`git diff`查看完整diff\n   - 识别变更文件的关联关系\n   - 确认变更的目标分支和影响范围\n\n### 阶段2：影响范围分析\n\n3. **定位所有调用点**：\n   - 使用`rg`或`grep`搜索API的所有调用位置\n   - 检查是否有函数指针调用\n   - 搜索是否有动态加载或插件使用此API\n\n4. **分析数据流**：\n   - 追踪参数从调用方到API实现的完整路径\n   - 确认参数在每一层的处理逻辑\n   - 识别是否有中间转换或适配层\n\n5. **分析控制流**：\n   - 理解API的调用时机和条件\n   - 确认API在不同执行路径下的行为\n   - 评估并发或异步场景下的影响\n\n### 阶段3：兼容性评估\n\n6. **二进制兼容性检查**（结构体变更必做）：\n   - 对比变更前后的结构体布局\n   - 确认字段偏移量是否发生变化\n   - 评估对C++代码（offsetof、模板等）的影响\n   - 确认是否有外部模块直接访问结构体\n\n7. **源码兼容性检查**：\n   - 确认所有调用点是否已同步更新\n   - 评估是否有调用点被遗漏\n   - 检查是否有隐式依赖（如类型转换）\n\n8. **文档和工具影响**：\n   - 确认API文档是否需要更新\n   - 评估日志格式变更对解析工具的影响\n   - 检查是否有测试用例需要同步修改\n\n### 阶段4：风险识别\n\n9. **参数验证风险**：\n   - 检查新参数是否有范围校验\n   - 评估非法参数值的影响\n   - 确认错误处理是否适当\n\n10. **性能和安全风险**：\n    - 评估变更是否引入新的性能开销\n    - 检查是否有新的安全漏洞（如缓冲区溢出）\n    - 确认是否影响线程安全\n\n11. **向后兼容性风险**：\n    - 评估旧版本代码如何处理新API\n    - 确认是否有版本迁移机制\n    - 检查是否保留了必要的向后兼容层\n\n### 阶段5：审查输出\n\n12. **生成结构化评审意见**：\n    - 为每个问题标注文件路径和精确行号\n    - 说明问题类型（API兼容性/二进制兼容性/逻辑正确性等）\n    - 提供数据流、控制流和触发场景的深度分析\n    - 按严重程度分类（严重/中等/低/信息）\n\n13. **提供改进建议**：\n    - 针对识别的风险给出缓解措施\n    - 建议是否需要额外的测试或文档\n    - 评估是否需要版本化管理或迁移指南\n\n## 实践指导\n\n### 结构体变更最佳实践\n\n- **新增字段**：添加到结构体末尾，使用保留字段供未来扩展\n- **字段删除**：标记为deprecated而非直接删除，提供过渡期\n- **字段重排序**：避免在已发布版本中重排序字段\n- **对齐要求**：考虑不同平台的对齐要求，使用显式padding\n\n### API参数变更最佳实践\n\n- **参数新增**：考虑提供默认值或重载函数保持向后兼容\n- **参数删除**：先标记为deprecated，在主版本中移除\n- **参数类型修改**：评估是否需要类型转换函数\n\n### 日志格式变更注意事项\n\n- 在日志开头添加字段比在中间添加影响更小\n- 考虑使用键值对格式而非位置依赖格式\n- 同步更新日志解析脚本和文档\n\n## 检查清单\n\n### 变更识别\n- [ ] 已识别所有API变更点（函数/结构体/宏）\n- [ ] 已确认变更的目标分支和影响范围\n\n### 影响分析\n- [ ] 已定位所有调用点（包括间接调用）\n- [ ] 已完成数据流分析\n- [ ] 已完成控制流分析\n\n### 兼容性\n- [ ] 已评估二进制兼容性（结构体变更）\n- [ ] 已评估源码兼容性\n- [ ] 已确认所有调用点已正确更新\n- [ ] 已评估文档和工具影响\n\n### 风险识别\n- [ ] 已检查参数验证\n- [ ] 已评估性能影响\n- [ ] 已评估安全风险\n- [ ] 已评估向后兼容性\n\n### 审查输出\n- [ ] 已生成结构化评审意见（含行号）\n- [ ] 已提供深度分析（数据流/控制流/触发场景）\n- [ ] 已给出改进建议\n- [ ] 已按严重程度分类问题",
  "scope": "global"
}