{
  "problem_type": "Rust测试并发状态污染修复",
  "content": "**Rust测试并发状态污染诊断与修复方法论**\n\n## 问题重述\nRust测试套件在并行运行时出现间歇性失败，表现为：\n- 单独运行测试通过，完整套件运行失败\n- 测试间状态相互污染\n- 全局静态变量导致竞态条件\n\n## 可复用解决流程\n\n### 步骤1：快速诊断\n```bash\n# 验证并发问题\ncargo test -- --test-threads=1  # 串行运行\ncargo test                       # 并行运行（对比结果）\n```\n\n### 步骤2：定位污染源\n1. **识别全局状态**：查找`static`变量、`Lazy`初始化、`Mutex`使用\n2. **检查测试清理**：验证每个测试是否有完整的setup/teardown\n3. **分析失败模式**：记录哪些测试组合会导致失败\n\n### 步骤3：修复策略（按优先级）\n1. **测试隔离增强**：\n   - 在每个测试前调用清理函数（`clear_scopes()`, `reset_tmpfiles()`）\n   - 使用`#[serial]`属性标记状态依赖测试\n   - 实现更彻底的状态重置\n\n2. **并发控制**：\n   - 临时使用`--test-threads=1`确保稳定性\n   - 重构全局状态为线程局部存储\n   - 使用`std::sync::Once`确保初始化只执行一次\n\n3. **架构改进**：\n   - 将全局状态注入为测试参数\n   - 使用测试数据库/临时文件隔离\n\n### 步骤4：验证修复\n```bash\n# 多次运行验证稳定性\nfor i in {1..10}; do cargo test --quiet; done\n\n# 特定测试验证\ncargo test specific_test -- --nocapture\n```\n\n## 注意事项\n- 避免在测试中修改全局状态\n- 优先重构而非工作绕过\n- 记录并发安全的设计模式\n\n## 可选步骤\n- 使用`loom`进行并发测试\n- 集成CI中的并发测试验证\n- 添加内存泄漏检查"
}