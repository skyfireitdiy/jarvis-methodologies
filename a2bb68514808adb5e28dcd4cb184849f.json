{
  "problem_type": "C语言头文件跨平台兼容性审查",
  "content": "# C语言头文件跨平台兼容性审查方法论\n\n## 规则简介\n\n本方法论提供了C语言头文件条件编译与跨平台兼容性问题的系统性审查方法，用于识别和防止常见的链接错误、接口不一致等问题。适用于所有涉及条件编译和多平台编译的C/C++项目。\n\n## 你必须遵守的原则\n\n### 原则1：声明与定义一致性\n\n**要求说明：**\n\n- **必须**：确保函数声明和定义的条件编译宏完全一致\n- **必须**：公共头文件中的声明应该在所有平台都有对应定义（或弱符号）\n- **禁止**：声明无条件可见而定义有条件编译\n- **禁止**：声明有条件而定义无条件（可能导致符号冲突）\n\n### 原则2：接口隔离原则\n\n**要求说明：**\n\n- **必须**：公共头文件只声明所有平台都支持的接口\n- **必须**：平台特定函数放在平台特定头文件中\n- **建议**：使用明确的命名约定区分平台特定接口（如后缀、前缀）\n\n### 原则3：文档完整性\n\n**要求说明：**\n\n- **必须**：平台特定接口必须标注平台限制\n- **必须**：使用 Doxygen 风格注释说明适用平台\n- **建议**：在注释中说明非平台的行为（如返回默认值）\n\n## 你必须执行的操作\n\n### 阶段1：识别变更范围\n\n1. **步骤1**：读取所有变更的头文件和源文件\n2. **步骤2**：识别涉及条件编译的函数声明和定义\n3. **步骤3**：列出所有平台特定的宏定义（如 `#if (_LOGIC_BOARD == _LOGIC_NBSA03)`）\n\n### 阶段2：检查声明与定义一致性\n\n1. **步骤1**：对于每个函数声明，找到对应的定义位置\n2. **步骤2**：比较声明和定义的条件编译宏是否一致\n3. **步骤3**：检查是否存在\"声明无条件，定义有条件\"的情况\n4. **步骤4**：验证在所有目标平台上都能正确编译和链接\n\n### 阶段3：数据流和控制流分析\n\n1. **步骤1**：分析编译阶段的符号可见性（声明是否被包含）\n2. **步骤2**：分析链接阶段的符号解析（定义是否存在）\n3. **步骤3**：识别可能的\"undefined reference\"错误场景\n4. **步骤4**：检查调用点是否都有正确的条件编译保护\n\n### 阶段4：跨平台影响评估\n\n1. **步骤1**：识别所有目标平台配置\n2. **步骤2**：对每个平台模拟编译和链接过程\n3. **步骤3**：检查是否存在平台宏定义不一致的风险\n4. **步骤4**：评估未来新增代码的误用风险\n\n### 阶段5：文档和接口设计审查\n\n1. **步骤1**：检查是否有平台限制说明\n2. **步骤2**：评估头文件组织结构的合理性\n3. **步骤3**：检查是否符合接口隔离原则\n4. **步骤4**：验证命名约定的一致性\n\n## 实践指导\n\n### 常见问题模式\n\n**问题1：声明无条件，定义有条件**\n   ```\n// 头文件（无条件）\nBOOLEAN PlatformSpecificFunction(VOID);\n\n// 源文件（有条件）\n#if (PLATFORM == XXX)\nBOOLEAN PlatformSpecificFunction(VOID) { ... }\n#endif\n   ```\n后果：非XXX平台链接时出现\"undefined reference\"错误\n\n**问题2：声明有条件，定义无条件**\n   ```\n// 头文件（有条件）\n#if (PLATFORM == XXX)\nBOOLEAN PlatformSpecificFunction(VOID);\n#endif\n\n// 源文件（无条件）\nBOOLEAN PlatformSpecificFunction(VOID) { ... }\n   ```\n后果：可能在不同平台间导致符号冲突\n\n**问题3：缺少平台文档**\n   ```\n// 头文件（无文档说明）\nBOOLEAN PlatformSpecificFunction(VOID);\n   ```\n后果：其他开发者误用，导致跨平台问题\n\n### 修复方案选择\n\n**方案1：运行时判断（推荐）**\n- 移除函数定义的条件编译\n- 在函数内部使用运行时判断\n- 适用于：性能要求不高的场景\n\n**方案2：声明也加条件编译**\n- 将声明放回条件编译块\n- 适用于：完全平台特定的函数\n\n**方案3：弱符号定义**\n- 使用 `__attribute__((weak))` 提供默认实现\n- 适用于：支持编译器特定扩展的场景\n\n**方案4：重构头文件结构**\n- 创建平台特定头文件\n- 将平台特定声明移到对应头文件\n- 适用于：大型重构项目\n\n### 验证方法\n\n1. **多平台编译测试**\n   ```bash\n   # 在每个目标平台配置下编译\n   make clean\n   make CONFIG_PLATFORM=PLATFORM_A\n   make clean\n   make CONFIG_PLATFORM=PLATFORM_B\n   ```\n\n2. **符号表检查**\n   ```bash\n   # 检查符号是否存在\n   nm -u object_file.o | grep FunctionName\n   ```\n\n3. **静态分析**\n   - 使用工具扫描条件编译块\n   - 验证声明和定义的一致性\n\n## 检查清单\n\n### 代码审查检查项\n\n- [ ] 所有函数声明和定义的条件编译宏是否一致\n- [ ] 公共头文件是否只包含所有平台都支持的接口\n- [ ] 平台特定接口是否有明确的文档说明\n- [ ] 是否进行了多平台编译测试\n- [ ] 头文件组织是否符合接口隔离原则\n- [ ] 是否存在循环依赖问题\n- [ ] 命名约定是否清晰且一致\n\n### 修复验证检查项\n\n- [ ] 在所有目标平台配置下编译成功\n- [ ] 链接阶段无\"undefined reference\"错误\n- [ ] 运行时行为符合预期\n- [ ] 文档已更新并说明平台限制\n- [ ] 代码审查已通过\n\n## 典型案例分析\n\n### 案例：NBSA03平台函数跨平台问题\n\n**问题描述**：\n- 函数 `IsStartNBSA03HWMFunction` 声明移到公共头文件（无条件）\n- 函数定义仍在 `#if (_LOGIC_BOARD == _LOGIC_NBSA03)` 块内\n- 导致非NBSA03平台链接失败\n\n**数据流分析**：\n1. 非NBSA03平台编译包含该头文件的代码\n2. 编译器看到函数声明，生成符号引用\n3. 链接器找不到符号定义（定义在条件编译块内）\n4. 链接失败：undefined reference\n\n**修复方案**：\n采用方案1，移除函数定义的条件编译，改为运行时判断\n\n**经验教训**：\n- 公共头文件的设计必须考虑所有平台\n- 条件编译的一致性至关重要\n- 需要建立多平台编译验证机制",
  "scope": "global"
}