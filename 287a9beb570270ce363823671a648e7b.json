{
  "problem_type": "Gerrit代码审查异常处理",
  "content": "# Gerrit 代码审查异常处理方法论\n\n## 规则简介\n\n本方法论提供了在执行 Gerrit 代码审查时遇到各种异常情况的处理策略和最佳实践。包括本地代码库不存在、网络访问失败、认证失败等常见问题的解决方案。\n\n## 你必须遵守的原则\n\n### 1. 优先级原则\n\n**要求说明：**\n\n- **必须**：优先使用 API 方式获取代码变更信息\n- **必须**：其次尝试临时克隆代码库\n- **必须**：最后才考虑手动操作或跳过审查\n- **禁止**：在未尝试所有可行方案前直接放弃任务\n\n### 2. 降级处理原则\n\n**要求说明：**\n\n- **必须**：当理想方案失败时，立即尝试次优方案\n- **必须**：记录每种方案的执行结果和失败原因\n- **必须**：在非交互模式下自动尝试所有可行方案\n- **禁止**：因单次失败就中断整个审查流程\n\n### 3. 信息完整性原则\n\n**要求说明：**\n\n- **必须**：尽可能获取完整的代码变更信息\n- **必须**：记录变更的文件列表、修改行数、提交信息等元数据\n- **必须**：在无法获取完整代码时，至少获取变更摘要\n- **禁止**：在没有任何代码信息的情况下给出审查意见\n\n## 你必须执行的操作\n\n### 阶段1：异常识别\n\n1. **识别异常类型**：\n   - 本地代码库不存在\n   - Git fetch/clone 超时或失败\n   - Gerrit API 认证失败\n   - 网络连接问题\n   - 权限不足\n\n2. **评估影响范围**：\n   - 是否影响代码审查的可行性\n   - 是否有替代方案可用\n   - 是否需要用户介入\n\n### 阶段2：方案尝试（按优先级）\n\n1. **方案A：使用 Gerrit API（首选）**\n   \n   **执行步骤：**\n   - 使用 `oss gerrit get-change-detail <change-id>` 获取变更详情\n   - 使用 `oss gerrit change-files <change-id>` 获取文件列表\n   - 尝试通过 API 获取每个文件的 diff 内容\n   - 在内存中解析和分析代码变更\n   \n   **适用场景：**\n   - 有 oss 工具且认证配置正确\n   - 网络可以访问 Gerrit API\n   - 只需要查看变更内容，不需要完整代码库\n\n2. **方案B：临时克隆代码库**\n\n   **执行步骤：**\n   - 在 /tmp 目录创建临时目录\n   - 使用 `git clone --depth=1` 克隆仓库（减少克隆时间）\n   - 使用 `git fetch` 获取特定 patchset\n   - 执行代码审查\n   - 审查完成后清理临时目录\n   \n   **适用场景：**\n   - API 方式失败\n   - 需要完整的代码上下文\n   - 网络条件允许\n\n   **优化建议：**\n   - 使用 `--depth=1` 只克隆最近提交\n   - 使用 `--single-branch` 只克隆目标分支\n   - 设置合理的超时时间（如 180 秒）\n\n3. **方案C：使用 git worktree（如果有本地仓库）**\n\n   **执行步骤：**\n   - 在已有的 git 仓库中创建 worktree\n   - 在 worktree 中获取 Gerrit 变更\n   - 审查完成后删除 worktree\n   \n   **适用场景：**\n   - 本地有相关项目的 git 仓库\n   - 不想完整克隆新仓库\n\n4. **方案D：网页查看+手动复制（最后手段）**\n\n   **执行步骤：**\n   - 在浏览器中打开 Gerrit 变更页面\n   - 手动复制关键代码文件\n   - 使用临时文件进行审查\n   \n   **适用场景：**\n   - 所有自动化方案都失败\n   - 交互模式下可以请求用户提供代码\n\n### 阶段3：结果处理\n\n1. **成功情况**：\n   - 执行正常的代码审查流程\n   - 使用七维度审查方法论\n   - 提交审查意见到 Gerrit\n\n2. **部分成功情况**：\n   - 只获取到部分代码信息\n   - 基于可用信息给出初步审查意见\n   - 明确标注信息不完整的部分\n   - 建议用户进行人工复核\n\n3. **完全失败情况**：\n   - 记录详细的失败原因\n   - 提供明确的后续操作建议\n   - 在非交互模式下保存任务状态\n   - 提醒用户需要手动处理\n\n## 实践指导\n\n### 最佳实践\n\n1. **提前准备**：\n   - 确保本地有常用项目的 git 仓库\n   - 配置好 Gerrit 认证信息\n   - 准备好网络代理（如果需要）\n\n2. **超时设置**：\n   - Git clone/fetch: 180 秒\n   - API 请求: 30 秒\n   - 文件下载: 60 秒\n\n3. **错误处理**：\n   - 记录每个方案的执行日志\n   - 保存中间结果便于恢复\n   - 提供清晰的错误提示\n\n### 常见错误及解决\n\n| 错误类型 | 原因 | 解决方案 |\n|---------|------|---------|\n| \"repository not found\" | 代码库路径错误 | 使用 fd 或 find 搜索，或直接克隆 |\n| \"Authentication failed\" | Gerrit 认证失败 | 检查 .netrc 或 git 配置 |\n| \"Connection timeout\" | 网络超时 | 使用代理、增加超时时间、重试 |\n| \"Unauthorized\" | API 需要认证 | 配置正确的认证信息 |\n\n### 非交互模式策略\n\n在非交互模式下，应：\n1. 自动尝试所有可行方案\n2. 每个方案失败后立即尝试下一个\n3. 记录所有尝试的详细日志\n4. 最终失败时给出完整的诊断报告\n5. 保存任务状态便于后续恢复\n\n## 检查清单\n\n在执行 Gerrit 代码审查时：\n\n- [ ] 确认变更 ID 和 patchset 编号\n- [ ] 检查本地是否有对应代码库\n- [ ] 确认 Gerrit 认证配置正确\n- [ ] 尝试 API 方式获取变更信息\n- [ ] 如需克隆，使用优化参数（--depth=1）\n- [ ] 设置合理的超时时间\n- [ ] 记录所有尝试的执行日志\n- [ ] 在部分成功时明确标注限制\n- [ ] 完全失败时提供清晰的后续建议",
  "scope": "global"
}