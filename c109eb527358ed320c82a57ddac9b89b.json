{
  "problem_type": "Gerrit代码深度审查",
  "content": "# Gerrit代码深度审查方法论\n\n## 规则简介\n\n本方法论提供了对Gerrit代码变更进行深度审查的系统化流程，重点关注线程安全、内存安全、错误处理等关键问题，适用于C/C++项目的代码审查。\n\n## 你必须遵守的原则\n\n### 原则1：全面性优先\n\n**要求说明：**\n\n- **必须**：按照七维度（线程安全、内存安全、错误处理、缓冲区安全、参数校验、逻辑正确性、资源泄露）进行全面检查\n- **必须**：每个问题必须标注具体行号或范围\n- **必须**：每个问题必须提供触发场景分析（数据流、控制流）\n- **禁止**：仅凭代码表面印象给出评审意见\n\n### 原则2：问题分级明确\n\n**要求说明：**\n\n- **必须**：按严重程度分类问题（严重/中等/低）\n- **必须**：严重问题：安全漏洞、功能缺陷、资源泄露、线程安全问题\n- **必须**：中等问题：性能问题、可维护性问题、边界条件\n- **必须**：低级问题：代码风格、命名规范、文档缺失\n- **禁止**：模糊的问题描述或无分级\n\n### 原则3：修复建议具体\n\n**要求说明：**\n\n- **必须**：为每个问题提供具体的修复建议或代码示例\n- **必须**：说明问题的根本原因，而不仅仅是现象\n- **必须**：评估修复方案的可行性和影响范围\n- **禁止**：仅指出问题但不提供解决方案\n\n## 你必须执行的操作\n\n### 阶段1：准备阶段\n\n1. **获取变更信息**：使用 `oss gerrit get-change-detail <change-id>` 获取变更元信息\n2. **获取完整patch**：使用 `oss gerrit get-patch <change-id>` 获取所有文件的diff内容\n3. **保存任务上下文**：使用 `save_memory` 保存变更信息到短期记忆\n\n### 阶段2：分析阶段\n\n1. **识别关键变更**：\n   - 新增文件：重点审查安全性、资源管理\n   - 修改文件：关注变更点的上下文影响\n   - 删除代码：检查是否有遗留依赖\n\n2. **七维度深度检查**：\n\n   **维度1：线程安全**\n   - 检查static变量懒加载是否有锁保护\n   - 检查全局变量/回调指针的并发访问\n   - 检查多文件操作的原子性\n   - 检查结构体成员写入的原子性\n\n   **维度2：内存安全**\n   - 检查mmap/malloc的配对性和边界\n   - 检查指针算术的越界风险（尤其是ELF解析）\n   - 检查memcpy的参数顺序和缓冲区大小\n   - 检查错误路径的资源释放\n\n   **维度3：错误处理**\n   - 检查所有错误路径是否正确释放资源\n   - 检查错误返回值是否正确传递\n   - 检查错误日志是否充分\n\n   **维度4：缓冲区安全**\n   - 检查strncpy是否保证null终止\n   - 检查memcpy的源缓冲区大小验证\n   - 检查数组访问的边界检查\n\n   **维度5：参数校验**\n   - 检查公共API的参数空指针检查\n   - 检查参数范围验证\n   - 检查枚举值的有效性\n\n   **维度6：逻辑正确性**\n   - 检查边界条件处理（0、-1、MAX等）\n   - 检查整数溢出风险\n   - 检查循环条件和终止条件\n\n   **维度7：资源泄露**\n   - 检查文件描述符是否关闭\n   - 检查mmap是否munmap\n   - 检查malloc是否free\n   - 检查错误路径的资源释放\n\n### 阶段3：报告生成\n\n1. **输出JSON格式评审意见**：\n   ```json\n   {\n     \"文件路径\": [\n       {\"line\": 行号, \"message\": \"【评审】[严重/中等/低] 问题描述\"},\n       {\"range\": {\"start_line\": 起始行, \"end_line\": 结束行}, \"message\": \"问题描述\"}\n     ]\n   }\n   ```\n\n2. **问题描述格式**：\n   - 严重程度标注：[严重/中等/低]\n   - 触发场景：具体的数据流、控制流、输入条件\n   - 影响分析：安全风险、功能缺陷、性能问题\n   - 修复建议：具体的修复方案或代码示例\n\n3. **保存审查结果**：使用 `save_memory` 保存审查结果和经验到长期记忆\n\n### 阶段4：应用评审\n\n1. **设置评审意见**：使用 `oss gerrit set-review <change-id> --comments-file <json-file>`\n2. **建议评分**：\n   - Code-Review -2：有严重安全问题或功能缺陷\n   - Code-Review -1：有中等问题需要修复\n   - Code-Review 0：仅有低级问题或无需修改\n\n## 实践指导\n\n### 常见问题模式\n\n**1. ELF文件解析安全**\n- **问题**：指针算术前只检查base_offset < buffer_size\n- **修复**：添加完整检查 `base_offset + sizeof(struct) * count < buffer_size`\n- **严重程度**：严重\n\n**2. mmap生命周期管理**\n- **问题**：函数内mmap传递给被调用者，然后立即munmap\n- **检查**：被调用函数是否缓存指针而非拷贝数据\n- **修复**：在函数文档中明确说明生命周期要求\n- **严重程度**：严重\n\n**3. 线程安全 - 懒加载缓存**\n- **问题**：static变量 + 首次检查 + 写入，无锁保护\n- **修复**：使用pthread_once、atomic操作或模块初始化阶段预调用\n- **严重程度**：中等\n\n**4. 线程安全 - 非原子操作**\n- **问题**：多文件操作、结构体成员写入、无锁保护\n- **修复**：调用方加锁、pthread_once、确认原子性\n- **严重程度**：严重\n\n**5. 宏定义语义问题**\n- **问题**：宏中将fd设置为0而非-1，后续if (fd >= 0)仍通过\n- **修复**：设置为-1，或改为static inline函数\n- **严重程度**：中等\n\n### 代码审查检查清单\n\n**线程安全检查**\n- [ ] static变量是否有锁保护？\n- [ ] 懒加载初始化是否使用pthread_once？\n- [ ] 全局变量/回调指针的并发访问是否原子？\n- [ ] 多文件操作是否需要加锁保护？\n\n**内存安全检查**\n- [ ] 指针算术是否检查完整边界？\n- [ ] mmap/malloc是否配对释放？\n- [ ] 错误路径是否释放资源？\n- [ ] memcpy参数顺序是否正确？\n\n**错误处理检查**\n- [ ] 所有错误路径是否释放资源？\n- [ ] 错误返回值是否正确传递？\n- [ ] 错误日志是否充分？\n\n**缓冲区安全检查**\n- [ ] strncpy是否保证null终止？\n- [ ] memcpy是否验证缓冲区大小？\n- [ ] 数组访问是否检查边界？\n\n**参数校验检查**\n- [ ] 公共API是否检查NULL指针？\n- [ ] 参数范围是否验证？\n- [ ] 枚举值是否有效？\n\n**逻辑正确性检查**\n- [ ] 边界条件是否处理（0、-1、MAX）？\n- [ ] 整数运算是否可能溢出？\n- [ ] 循环条件是否正确？\n\n**资源泄露检查**\n- [ ] 文件描述符是否关闭？\n- [ ] mmap是否munmap？\n- [ ] malloc是否free？\n- [ ] 错误路径是否释放资源？\n\n## 检查清单\n\n**审查前准备**\n- [ ] 已获取变更详情和完整patch\n- [ ] 已保存任务上下文到记忆\n- [ ] 已加载相关代码规范\n\n**审查过程**\n- [ ] 已识别所有新增/修改文件\n- [ ] 已按七维度进行全面检查\n- [ ] 已为每个问题标注行号和严重程度\n- [ ] 已提供触发场景和修复建议\n\n**审查输出**\n- [ ] 已生成JSON格式评审意见\n- [ ] 已保存审查结果到长期记忆\n- [ ] 已设置Gerrit评审意见\n\n**质量验证**\n- [ ] 问题描述具体、可验证\n- [ ] 修复建议可行、有依据\n- [ ] 问题分级合理、有标准\n- [ ] 覆盖所有关键变更点",
  "scope": "global"
}