{
  "problem_type": "Rust测试覆盖率优化",
  "content": "## Rust 测试覆盖率优化方法论\n\n### 问题重述\n提升 Rust 项目测试覆盖率时，可能会遇到条件编译代码、unsafe 代码等无法在测试环境中覆盖的情况，导致难以达到覆盖率目标。\n\n### 可复用解决流程\n\n#### 1. 分析覆盖率基线\n```bash\ncargo llvm-cov test --features all -p crate_name --lib 2>&1 | grep -A 5 'target_file.rs'\n```\n- 记录当前 line 和 region 覆盖率\n- 识别未覆盖的代码行和函数\n\n#### 2. 区分可测试与不可测试代码\n使用以下命令识别条件编译代码：\n```bash\ngrep -n 'cfg.*not.*test' target_file.rs\ngrep -n 'cfg.*feature' target_file.rs\n```\n\n**不可测试代码类型**：\n- `#[cfg(not(test))]` 包裹的代码（生产环境专用）\n- `#[cfg(feature = \"...\")]` 未启用特性的代码\n- `unsafe` 代码中的实际内存访问操作\n\n#### 3. 计算实际可测试覆盖率上限\n```\n总行数：N\n不可测试代码行数：M\n实际可测试代码：N - M\n实际覆盖率 = 已覆盖行数 / (N - M) * 100%\n```\n\n**原则**：排除不可测试代码后，实际覆盖率 ≥ 80% 即可视为达标。\n\n#### 4. 补充测试用例\n按优先级补充测试：\n\n**P0 - Trait 实现**：\n- `Debug`, `Display`, `PartialEq`, `PartialOrd`, `Clone` 等标准 trait\n- 测试所有字段的正确性和克隆后的独立性\n\n**P1 - 边界条件**：\n- 空集合、单元素、最大值、最小值\n- 错误路径和异常场景\n- 原子类型的并发更新\n\n**P2 - 功能完整性**：\n- 所有公共函数的测试\n- 复杂逻辑的分支覆盖\n\n**测试文件组织规范**：\n```rust\n#[test]\n/// # 分类\n/// Trait实现测试\n///\n/// # 场景\n/// 验证XXX的XXX trait实现\n///\n/// # 用例\n/// 创建XXX实例，验证XXX行为\n///\n/// # 通过准则\n/// 1. 预期结果1\n/// 2. 预期结果2\nfn test_xxx_feature() {\n    // 测试代码\n}\n```\n\n#### 5. 验证覆盖率提升\n```bash\n# 只运行相关测试，提升验证速度\ncargo test --features all -p crate_name target_ft --lib\n\n# 运行覆盖率测试\ncargo llvm-cov test --features all -p crate_name --lib target_ft\n```\n\n#### 6. 调整预期目标\n如果条件编译代码占比超过 20%：\n- 与团队确认是否需要调整覆盖率目标\n- 考虑是否可以将部分条件编译代码提取为独立可测试模块\n\n### 注意事项\n\n1. **不要为不可测试代码编写测试**\n   - 条件编译代码无法在测试中执行\n   - 强行测试会浪费时间\n\n2. **测试质量优先于覆盖率数字**\n   - 避免编写无意义的测试只为提升覆盖率\n   - 每个测试应该有明确的业务含义\n\n3. **使用辅助函数简化测试**\n   - 复杂的 mock 对象提取为辅助函数\n   - 使用 rstest 等框架参数化测试\n\n4. **原子类型测试注意事项**\n   - 使用 Arc 包装以支持多线程测试\n   - 验证克隆后的原子字段独立性\n\n### 可选步骤\n\n#### 处理 handle_msg_duration 类型的函数\n这些函数需要复杂的依赖（Job, Scheduler），测试成本极高：\n\n**策略 A - 集成测试**：\n在 job_ft.rs 中已有完整测试环境的情况下，通过集成测试覆盖。\n\n**策略 B - 提取逻辑**：\n将核心逻辑提取为独立函数，使测试更容易。\n\n**策略 C - 接受不覆盖**：\n如果函数代码量不大（< 50 行），接受不覆盖，重点关注其他可测试代码。\n\n### 验证标准\n\n1. region 覆盖率 ≥ 70%\n2. 实际可测试代码的 line 覆盖率 ≥ 80%（排除条件编译代码）\n3. 所有测试用例包含完整的四部分注释\n4. 测试运行通过且无编译错误",
  "scope": "global"
}