{
  "problem_type": "C作用域链查找函数转译",
  "content": "**问题重述**：将C语言中基于链表的作用域查找函数（如find_var）转译为Rust，保持语义等价。\n\n**可复用解决流程**：\n\n1. **结构映射分析**\n   - C: `Scope *scope` → Rust: `thread_local! { static SCOPE: RefCell<Option<Box<Scope>>> }`\n   - C: 链表遍历 `for(Scope *sc = scope; sc; sc = sc->next)` → Rust: `while let Some(scope_ref) = sc`\n\n2. **测试设计（Red阶段）**\n   - 基本查找成功\n   - 变量未找到\n   - 作用域链查找\n   - 变量遮蔽机制\n   - 空边界条件\n\n3. **实现要点（Green阶段）**\n   ```rust\n   // 变量名提取（处理长度边界）\n   let var_name = if tok.len <= tok.loc.len() {\n       &tok.loc[..tok.len]\n   } else {\n       &tok.loc\n   };\n  \n   // 哈希表查找（安全处理裸指针）\n   unsafe {\n       if let Some(ptr) = hashmap_get2(&scope.vars, var_name.as_bytes()) {\n           if !ptr.is_null() {\n               let ref_data = &*(ptr as *const T);\n               return Some(Box::new(ref_data.clone())); // 克隆避免内存问题\n   }\n   }\n   }\n   ```\n\n4. **内存安全注意事项**\n   - 避免直接使用`Box::from_raw`从哈希表指针\n   - 使用克隆模式创建新实例\n   - 确保生命周期管理正确\n\n5. **可选优化步骤**\n   - 使用Cow减少克隆开销\n   - 添加缓存机制提升性能\n   - 实现调试trait便于测试"
}