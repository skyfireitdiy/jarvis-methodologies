{
  "problem_type": "Textual框架组件挂载错误",
  "content": "## 问题重述\n在Textual TUI框架中，当尝试在容器组件（如ScrollableContainer、Horizontal等）被框架挂载之前向其mount子组件时，会抛出MountError异常。\n\n## 可复用解决流程\n\n### 步骤1：识别问题\n- 错误信息示例：`MountError: Can't mount widget(s) before <ContainerType> is mounted`\n- 通常出现在compose()方法中直接调用container.mount()时\n\n### 步骤2：分析代码结构\n检查是否存在以下模式：\n```python\ndef compose(self) -> ComposeResult:\n    container = SomeContainer(id=\"xxx\")\n    container.mount(child_widget)  # ❌ 错误\n    yield container\n```\n\n### 步骤3：定位问题容器\n使用grep或ripgrep搜索包含以下模式的代码：\n- `container.mount(` 在 `compose` 方法中\n- `_build_xxx()` 方法返回容器并在内部调用mount\n\n### 步骤4：应用修复模式\n\n**模式A：延迟挂载到on_mount（推荐）**\n```python\ndef compose(self) -> ComposeResult:\n    \"\"\"组合应用组件。\"\"\"\n    yield Header()\n    yield ScrollableContainer(id=\"form-container\")  # 不在这里挂载子组件\n    yield Horizontal(id=\"button-container\", classes=\"button-container\")\n    yield Footer()\n\ndef on_mount(self) -> None:\n    \"\"\"应用挂载时调用。\"\"\"\n    # 获取容器引用\n    form_container = self.query_one(\"#form-container\", ScrollableContainer)\n    button_container = self.query_one(\"#button-container\", Horizontal)\n   \n    # 挂载子组件（容器已被框架挂载，安全）\n    self._populate_form_container(form_container)\n    button_container.mount(Button(\"提交\", id=\"submit\"))\n    button_container.mount(Button(\"取消\", id=\"cancel\"))\n```\n\n**模式B：使用compose的yield模式（适用于静态组件）**\n```python\ndef _build_buttons(self) -> ComposeResult:\n    \"\"\"构建按钮容器。\"\"\"\n    with Horizontal(classes=\"button-container\"):\n        yield Button(\"提交\", variant=\"primary\", id=\"submit\")\n        yield Button(\"取消\", variant=\"default\", id=\"cancel\")\n```\n\n### 步骤5：验证修复\n```bash\n# 1. 静态检查\npython3 -m py_compile src/your_app.py\n\n# 2. 导入测试\npython3 -c \"from your_module import YourApp\"\n\n# 3. 初始化测试（模拟挂载）\npython3 -c \"\nfrom your_module import YourApp\napp = YourApp()\nlist(app.compose())\napp.on_mount()\nprint('Success: No MountError')\n\"\n```\n\n## 注意事项\n1. **生命周期顺序**：compose() → 框架挂载 → on_mount()\n2. **query_one时机**：只能在容器被挂载后使用query_one获取引用\n3. **静态vs动态**：\n   - 静态组件结构使用yield模式\n   - 动态内容使用on_mount挂载\n4. **嵌套容器**：嵌套容器也需要遵循相同规则\n5. **ID引用**：给容器设置id便于在on_mount中获取引用\n\n## 常见陷阱\n- ❌ 在compose()返回的容器对象上调用mount()\n- ❌ 在自定义容器的__init__中挂载子组件\n- ❌ 在容器被yield之前调用mount()\n- ✅ 使用on_mount生命周期方法\n- ✅ 使用with上下文管理器的yield模式\n\n## 相关文件\n- 问题文件：src/jarvis/jarvis_config/tui_app.py\n- 已修复：on_mount()方法（第160-166行）\n- 未修复：_build_buttons()方法（第254-264行）"
}