{
  "problem_type": "深度代码审查",
  "content": "# 深度代码审查方法论\n\n## 规则简介\n\n本方法论提供了一套系统化的深度代码审查流程，通过七个维度全面分析代码质量问题，特别强调多线程安全、内存安全和资源管理等方面。适用于需要严谨代码质量保障的场景，如Gerrit代码评审、核心模块审查等。\n\n## 你必须遵守的原则\n\n### 深度分析原则\n\n**要求说明：**\n\n- **必须**：对于非风格类问题（逻辑问题、安全问题、性能问题等），必须进行深度分析\n- **禁止**：仅凭表面现象判断问题，必须深入理解代码逻辑\n- **必须**：提供问题触发的具体场景，包括数据流、控制流和触发条件\n- **禁止**：使用模糊描述代替精确的问题定位\n\n### 行号校验原则\n\n**要求说明：**\n\n- **必须**：对所有发现问题的行号进行校验，确保行号准确\n- **必须**：使用代码读取工具验证问题代码所在行的实际内容\n- **禁止**：直接引用未经校验的行号\n- **禁止**：在报告中引用不存在的行号\n\n### 证据导向原则\n\n**要求说明：**\n\n- **必须**：每个问题都要有明确的代码证据\n- **必须**：记录行号校验结果，包括文件路径、行号、代码内容摘要\n- **禁止**：凭推测或假设提出问题\n\n## 你必须执行的操作\n\n### 阶段1：代码理解\n\n1. **读取关键代码**：使用代码读取工具分批读取代码，优先关注核心逻辑\n2. **理解整体架构**：分析模块结构、函数调用关系、数据流向\n3. **识别关键特征**：标记全局变量、静态变量、共享资源、并发访问点\n\n### 阶段2：七维度审查\n\n**维度1：线程安全**\n- 检查全局变量/静态变量的并发访问\n- 检查共享资源的锁保护机制\n- 分析是否存在竞态条件、死锁风险\n- **数据流分析**：追踪共享数据的读写路径\n- **控制流分析**：识别并发执行的代码路径\n- **触发场景**：描述多线程同时访问的具体情况\n\n**维度2：内存安全**\n- 检查动态内存分配和释放\n- 检查是否存在悬空指针、野指针\n- 检查是否存在内存泄漏、重复释放\n- **数据流分析**：追踪内存的生命周期\n- **触发场景**：描述访问已释放内存的路径\n\n**维度3：错误处理**\n- 检查函数返回值是否处理\n- 检查异常情况的处理逻辑\n- 检查错误传播机制\n- **触发场景**：描述错误处理缺失导致的问题\n\n**维度4：缓冲区安全**\n- 检查数组访问是否越界\n- 检查字符串操作是否安全\n- 检查缓冲区大小校验\n- **数据流分析**：追踪缓冲区大小的传递路径\n- **触发场景**：描述触发越界的输入条件\n\n**维度5：参数校验**\n- 检查函数参数的有效性校验\n- 检查指针参数是否为NULL\n- 检查数组参数的长度校验\n- **触发场景**：描述导致校验绕过的输入\n\n**维度6：逻辑正确性**\n- 检查业务逻辑是否符合预期\n- 检查边界条件处理\n- 检查状态机转换的正确性\n- **控制流分析**：追踪逻辑分支\n- **触发场景**：描述导致逻辑错误的输入序列\n\n**维度7：资源管理**\n- 检查文件句柄、网络连接、定时器等资源的释放\n- 检查资源获取和释放的配对\n- 检查异常情况下的资源清理\n- **触发场景**：描述资源泄漏的路径\n\n### 阶段3：行号校验\n\n1. **使用代码读取工具**：对每个发现的问题，读取目标文件的相关行\n2. **验证行号存在**：确认行号在文件范围内\n3. **验证内容匹配**：确认代码内容与问题描述一致\n4. **记录校验结果**：保存文件路径、行号、代码内容摘要\n\n**校验记录格式**：\n```\n[行号校验通过] <文件路径>:<行号>\n代码内容: <目标行的代码内容摘要>\n```\n\n### 阶段4：问题分级\n\n根据以下标准对问题进行分级：\n\n**严重**：\n- 线程安全问题：可能导致数据竞争、死锁\n- 内存安全问题：可能导致内存泄漏、use-after-free\n- 安全漏洞：可能导致缓冲区溢出、空指针解引用\n\n**中等**：\n- 参数校验缺失：可能导致未定义行为\n- 错误处理不完善：可能导致问题掩盖\n- 资源管理问题：可能导致资源泄漏\n\n**低优先级**：\n- 代码风格问题：不影响功能\n- 可维护性问题：但不影响正确性\n- 性能优化建议：不影响功能\n\n### 阶段5：生成报告\n\n1. **结构化输出**：按严重程度分类展示问题\n2. **包含代码证据**：每个问题附带代码摘要\n3. **提供修复建议**：给出具体的修复方案或代码示例\n4. **明确评分建议**：根据问题严重程度给出评分建议\n\n**报告格式**：\n```markdown\n## 代码审查报告\n\n### === 严重问题 (N) ===\n1. [文件:行号] ✅已校验 - 问题描述\n   代码摘要: <目标行的代码内容摘要>\n   问题分析:\n   - 数据流: <数据流动路径>\n   - 控制流: <执行流程路径>\n   - 触发场景: <具体触发条件>\n   建议修复: <修复方案>\n\n### === 中等问题 (N) ===\n...\n\n### === 低优先级 (N) ===\n...\n```\n\n## 实践指导\n\n### 深度分析技巧\n\n1. **数据流追踪**：从输入开始，追踪数据如何经过一系列函数调用到达问题代码\n2. **控制流追踪**：从程序入口开始，追踪执行路径如何到达问题代码\n3. **并发分析**：识别所有可能并发执行的代码路径，分析共享资源的访问模式\n4. **边界条件**：考虑输入的边界值、NULL指针、空数组等情况\n\n### 常见问题模式\n\n**线程安全**：\n- 全局变量/静态变量无锁保护\n- 检查-使用（check-then-act）竞态条件\n- 锁的获取和释放顺序不一致\n\n**内存安全**：\n- malloc后未free（内存泄漏）\n- free后继续使用（use-after-free）\n- 重复free（double-free）\n\n**资源管理**：\n- 文件打开后未关闭\n- 锁获取后未释放\n- 定时器创建后未取消\n\n### 避免常见错误\n\n1. **不要凭直觉判断**：必须通过代码读取工具验证\n2. **不要忽略上下文**：要理解代码的调用场景\n3. **不要过度审查**：风格问题除非严重影响可读性，否则不建议提出\n4. **不要只提问题不提方案**：要给出具体的修复建议\n\n## 检查清单\n\n完成深度代码审查后，确认：\n\n- [ ] 已完成七维度全面审查\n- [ ] 所有问题行号已使用代码读取工具校验\n- [ ] 对非风格类问题进行了深度分析（数据流、控制流、触发场景）\n- [ ] 问题分级合理，严重程度准确\n- [ ] 每个问题都有明确的修复建议\n- [ ] 报告格式规范，代码证据充分\n- [ ] 评分建议合理，有充分依据",
  "scope": "global"
}