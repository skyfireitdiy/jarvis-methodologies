{
  "problem_type": "C_code_review_API_migration",
  "content": "# C语言代码审查方法论（API变更与模块迁移）\n\n## 规则简介\n\n本方法论提供系统性的C语言代码审查流程，重点关注API接口变更、功能模块迁移、初始化顺序调整等高风险变更场景。适用于Gerrit代码审查、PR审查等场景。\n\n## 你必须遵守的原则\n\n### 原则1：理解变更上下文\n\n**要求说明：**\n\n- **必须**：首先阅读commit message，理解变更的业务目的和技术目标\n- **必须**：使用`git show --stat`查看变更文件列表和变更规模\n- **必须**：识别变更类型（新功能、重构、bug修复、性能优化等）\n- **禁止**：直接开始审查代码细节而不理解整体变更意图\n\n### 原则2：关注API兼容性\n\n**要求说明：**\n\n- **必须**：检查所有公开API接口的变更（函数签名、返回值类型、参数类型）\n- **必须**：评估返回值类型变更对现有调用者的影响\n- **必须**：确认宏定义、枚举值的变更是否破坏二进制兼容性\n- **禁止**：仅查看变更文件本身，忽略调用方的影响\n\n### 原则3：验证模块迁移完整性\n\n**要求说明：**\n\n- **必须**：确认源模块是否正确移除了相关代码（实现、声明、调用）\n- **必须**：确认目标模块是否完整实现了迁移的功能\n- **必须**：检查编译配置（CMakeLists.txt、Makefile）是否更新\n- **必须**：验证初始化和去初始化顺序是否正确调整\n- **禁止**：仅查看迁移的目标模块，忽略源模块的清理\n\n### 原则4：检查资源管理\n\n**要求说明：**\n\n- **必须**：所有动态内存分配（malloc/calloc）必须检查返回值\n- **必须**：确认错误路径上的资源释放\n- **必须**：验证文件操作、锁操作的正确获取和释放\n- **禁止**：假设资源分配总是成功\n\n## 你必须执行的操作\n\n### 阶段1：准备阶段\n\n1. **获取变更概览**：\n   - 使用`git show --stat`查看变更文件列表和行数统计\n   - 阅读commit message理解变更目的\n   - 识别核心变更文件和关联文件\n\n2. **检索相关记忆**：\n   - 查询项目长期记忆中是否有相关架构信息\n   - 查询全局记忆中是否有类似的审查经验\n   - 确认是否需要加载特定规则文件\n\n3. **制定审查计划**：\n   - 根据变更规模和复杂度，决定是否需要拆分任务\n   - 确定审查的优先级顺序（核心文件 > 关联文件 > 配置文件）\n\n### 阶段2：深度审查阶段\n\n#### 2.1 API接口变更检查\n\n1. **检查函数签名变更**：\n   ```bash\n   # 查看头文件中的函数声明变更\n   git diff <commit> -- *.h | grep -E \"^\\+.*\\(|^\\-.*\\(\"\n   ```\n\n2. **检查返回值类型变更**：\n   - 确认新旧类型的底层表示是否相同（如int vs long）\n   - 检查返回值语义是否改变（0表示成功 vs 非0表示成功）\n   - 评估是否影响跨模块/DLL边界的兼容性\n\n3. **搜索所有调用点**：\n   ```bash\n   # 搜索函数的所有调用位置\n   git grep \"函数名\" -- '*.c' '*.cpp'\n   ```\n   - 逐个检查调用点是否需要修改\n   - 确认是否有使用类型相关的宏（如OSS_SUCCESS）\n\n4. **检查宏和枚举变更**：\n   - 确认宏值的变更是否破坏现有代码\n   - 检查枚举成员的增删是否影响switch语句\n\n#### 2.2 模块迁移检查\n\n1. **源模块清理检查**：\n   - 确认实现代码已删除\n   - 确认头文件声明已删除\n   - 确认调用点已移除或重定向\n   - 检查注释和文档是否更新\n\n2. **目标模块完整性检查**：\n   - 确认功能完整实现\n   - 确认接口设计合理\n   - 检查错误处理是否完善\n\n3. **编译配置检查**：\n   - CMakeLists.txt是否添加新源文件\n   - Makefile是否更新依赖关系\n   - 头文件搜索路径是否调整\n\n#### 2.3 初始化顺序检查\n\n1. **依赖关系分析**：\n   - 绘制初始化依赖图\n   - 确认不存在循环依赖\n   - 验证初始化顺序满足依赖关系\n\n2. **条件编译检查**：\n   - 确认新增初始化代码有正确的条件编译保护\n   - 检查`#if defined()`宏是否正确定义\n\n3. **多线程安全检查**：\n   - 确认初始化完成前不会有多线程访问\n   - 检查是否需要加锁保护\n\n#### 2.4 资源管理检查\n\n1. **内存分配检查**：\n   ```c\n   // 正确示例\n   void *ptr = malloc(size);\n   if (ptr == NULL) {\n       // 错误处理\n       return ERROR;\n   }\n   ```\n\n2. **错误路径检查**：\n   - 所有可能失败的路径都有错误处理\n   - 错误处理中正确释放已分配的资源\n   - 使用goto进行集中错误清理（推荐）\n\n3. **文件和锁检查**：\n   - 确认fopen后检查返回值\n   - 确认lock后unlock在所有路径都执行\n   - 检查是否有资源泄漏\n\n#### 2.5 测试代码检查\n\n1. **测试完整性**：\n   - 确认新功能有对应的测试用例\n   - 检查测试覆盖率是否足够\n   - 验证测试用例的有效性\n\n2. **测试代码质量**：\n   - 测试代码也需要检查资源管理\n   - 确认测试代码的错误处理\n   - 检查测试代码的可维护性\n\n### 阶段3：问题整理阶段\n\n1. **问题分级**：\n   - **严重**：线程安全问题、内存泄漏、空指针解引用、资源泄漏、API不兼容\n   - **中等**：边界条件未处理、错误处理不完整、性能问题、注释不准确\n   - **低**：代码风格、命名规范、注释缺失\n\n2. **问题标注**：\n   - 所有问题使用行评论格式（文件:行号）\n   - 添加前缀：【Jarvis Agent自主评审】或【审查】\n   - 非风格类问题需要深度分析（数据流、控制流、触发条件）\n\n3. **生成报告**：\n   - 审查概要（文件列表、问题统计）\n   - 严重问题列表（阻塞合入，必须修复）\n   - 中等问题列表（建议修复）\n   - 低优先级问题列表\n   - 总结与建议（问题统计、修复优先级、代码质量评价）\n\n### 阶段4：验证阶段\n\n1. **API一致性验证**：\n   - 检查头文件声明与实现是否一致\n   - 验证函数参数类型匹配\n   - 确认宏定义在所有使用点一致\n\n2. **编译验证**：\n   - 确认代码可以通过编译\n   - 检查是否有新的警告\n   - 验证静态分析结果\n\n3. **功能验证**：\n   - 确认测试用例通过\n   - 验证性能基线未退化\n   - 检查资源使用是否合理\n\n## 实践指导\n\n### 常见问题和解决方案\n\n**问题1：API返回值类型变更影响兼容性**\n\n**解决方案**：\n- 如果只是类型别名变更（如typedef），确认底层类型一致\n- 如果语义改变，需要更新所有调用点\n- 考虑提供兼容层或迁移指南\n\n**问题2：模块迁移导致初始化顺序错误**\n\n**解决方案**：\n- 在初始化函数中添加注释说明依赖关系\n- 使用编译时断言（static_assert）验证依赖\n- 在文档中明确初始化顺序要求\n\n**问题3：测试代码中的内存泄漏**\n\n**解决方案**：\n- 测试代码也应该遵循资源管理规范\n- 使用valgrind等工具检测内存泄漏\n- 在测试结束时清理所有资源\n\n### 审查技巧\n\n1. **使用工具辅助**：\n   - 使用`git diff`快速定位变更\n   - 使用`ripgrep`搜索函数调用\n   - 使用静态分析工具（如clang-tidy）检查潜在问题\n\n2. **关注高风险区域**：\n   - 公开API接口\n   - 全局变量和静态变量\n   - 多线程访问的共享资源\n   - 错误处理路径\n\n3. **保持批判性思维**：\n   - 不要假设\"这样改一定没问题\"\n   - 追问\"为什么这样改？\"、\"是否所有场景都考虑了？\"\n   - 从调用者、维护者、测试者多个角度思考\n\n### 检查清单\n\n- [ ] 理解变更的业务目的和技术目标\n- [ ] 识别所有变更的文件和关联文件\n- [ ] 检查API接口变更的兼容性\n- [ ] 验证模块迁移的完整性\n- [ ] 确认初始化顺序正确性\n- [ ] 检查所有内存分配的返回值\n- [ ] 验证错误路径的资源释放\n- [ ] 检查多线程安全性\n- [ ] 确认测试代码质量\n- [ ] 生成结构化的审查报告\n- [ ] 提供修复建议和优先级",
  "scope": "global"
}