{
  "problem_type": "架构健康度分析工具开发",
  "content": "# 架构健康度分析工具开发方法论\n\n## 规则简介\n\n本方法论提供了开发架构健康度分析工具的完整流程和实现方法，适用于需要评估代码质量、识别架构缺陷、提供改进建议的场景。涵盖复杂度分析、依赖分析、重复度检测和健康度评分四大核心功能。\n\n## 你必须遵守的原则\n\n### 轻量级优先原则\n\n**要求说明：**\n\n- **必须**：优先使用语言标准库，避免引入外部依赖\n- **必须**：使用AST（抽象语法树）分析而非正则表达式，确保准确性\n- **必须**：数据类（dataclass）定义清晰的数据结构\n- **禁止**：引入重量级框架或库\n\n### 模块化设计原则\n\n**要求说明：**\n\n- **必须**：分离关注点，每个分析器独立模块\n- **必须**：定义清晰的接口和数据结构\n- **必须**：支持选择性分析（可单独启用/禁用某个分析器）\n- **禁止**：紧耦合设计，模块间应低耦合\n\n### 质量保证原则\n\n**要求说明：**\n\n- **必须**：每个模块必须有配套测试，覆盖率≥80%\n- **必须**：通过静态检查（ruff/mypy/bandit）\n- **必须**：使用类型注解和文档字符串\n- **禁止**：提交未测试或未通过检查的代码\n\n## 你必须执行的操作\n\n### 阶段1：模块框架搭建\n\n1. **创建模块结构**：\n   - 创建主分析器类（ArchitectureAnalyzer）\n   - 定义分析结果数据类（AnalysisResult）\n   - 定义报告数据类（ArchitectureReport）\n   - 创建统一的接口（analyze_project）\n\n2. **实现基础功能**：\n   - 路径遍历和文件过滤\n   - 报告生成和导出（JSON/Markdown/HTML）\n   - 测试框架搭建\n\n### 阶段2：复杂度分析器实现\n\n1. **圈复杂度计算**：\n   - 使用ast.NodeVisitor遍历AST\n   - 统计决策点：if/elif/else、for/while、try/except、with、逻辑运算符、lambda\n   - 计算公式：基础值1 + 决策点数量\n   - 阈值：>10为高复杂度\n\n2. **认知复杂度计算**：\n   - 递归访问AST节点，维护嵌套层级\n   - 计算方法：嵌套层级×2 + 逻辑运算符 + 分支跳转\n   - 识别难理解的代码\n\n3. **生成复杂度报告**：\n   - 列出高复杂度函数\n   - 提供重构建议（提取函数、提前返回等）\n\n### 阶段3：依赖分析器实现\n\n1. **构建依赖图**：\n   - 解析import语句\n   - 构建模块依赖关系图\n   - 使用邻接表存储\n\n2. **循环依赖检测**：\n   - 使用深度优先搜索（DFS）\n   - 维护递归栈，记录访问路径\n   - 检测并报告循环依赖\n\n3. **耦合度计算**：\n   - 出耦合度（Ce）= len(dependencies)\n   - 入耦合度（Ca）= len(dependents)\n   - 不稳定性（I）= Ce / (Ca + Ce)\n\n4. **生成依赖报告**：\n   - 列出循环依赖\n   - 识别高耦合模块\n   - 提供解耦建议\n\n### 阶段4：重复度分析器实现\n\n1. **代码提取**：\n   - 使用ast.FunctionDef提取函数定义\n   - 标准化代码（去除注释、空行）\n\n2. **相似度计算**：\n   - 使用difflib.SequenceMatcher\n   - 阈值：0.85（85%相似度）\n   - 哈希优化：MD5快速去重\n\n3. **生成重复报告**：\n   - 列出重复代码对\n   - 计算重复度评分\n   - 提供去重建议\n\n### 阶段5：健康度评分实现\n\n1. **评分系统设计**：\n   - 定义权重：复杂度30%、依赖35%、重复度35%\n   - 计算各维度得分（0-100）\n   - 加权平均计算总分\n\n2. **风险等级划分**：\n   - 健康（90-100）：代码质量优秀\n   - 良好（70-89）：代码质量良好\n   - 警告（50-69）：需要改进\n   - 危险（<50）：急需重构\n\n3. **优先级分类**：\n   - P0：循环依赖、高重复率（>15%）\n   - P1：高复杂度（>20）、高耦合\n   - P2：中等复杂度、一般问题\n\n4. **生成完整报告**：\n   - 汇总所有分析结果\n   - 按优先级排序改进建议\n   - 支持多种格式导出\n\n### 阶段6：测试与验证\n\n1. **单元测试**：\n   - 测试各种复杂度情况\n   - 测试循环依赖检测\n   - 测试重复度检测\n   - 测试评分计算\n\n2. **集成测试**：\n   - 测试完整分析流程\n   - 测试报告生成\n   - 测试边界情况\n\n3. **性能测试**：\n   - 测试大型项目分析性能\n   - 优化热点代码\n\n4. **质量检查**：\n   - 运行ruff检查代码风格\n   - 运行mypy进行类型检查\n   - 运行bandit进行安全检查\n   - 确保覆盖率≥80%\n\n## 实践指导\n\n**性能优化技巧**：\n\n- 使用哈希快速去重完全相同的代码\n- 按文件分组减少比较次数\n- 跳过测试文件和__pycache__\n- 设置最小函数长度过滤\n\n**常见错误及避免**：\n\n- 循环依赖检测需维护递归栈，避免误判\n- 认知复杂度计算需正确处理嵌套层级\n- 重复度检测需标准化代码后再比较\n- 评分算法需考虑各维度权重平衡\n\n**扩展建议**：\n\n- 支持更多语言（Java、JavaScript等）\n- 可视化依赖图和复杂度分布\n- 添加趋势分析（历史对比）\n- 集成到CI/CD流程\n\n## 检查清单\n\n- [ ] 模块结构完整，接口清晰\n- [ ] 复杂度分析准确（圈复杂度、认知复杂度）\n- [ ] 依赖分析完整（循环依赖、耦合度）\n- [ ] 重复度检测有效（相似度计算）\n- [ ] 健康度评分合理（权重配置、风险等级）\n- [ ] 测试覆盖率≥80%\n- [ ] 静态检查全部通过（ruff/mypy/bandit）\n- [ ] 报告格式完整（JSON/Markdown/HTML）\n- [ ] 性能满足要求（大型项目可接受）\n- [ ] 文档完善（使用说明、API文档）",
  "scope": "global"
}