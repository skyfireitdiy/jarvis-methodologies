{
  "problem_type": "代码版本对比测试",
  "content": "# 代码版本对比测试方法论\n\n## 规则简介\n\n本方法论用于在软件项目中对比不同代码版本的性能、内存或其他指标差异。通过标准化的测试流程，确保版本对比的科学性和可重复性。\n\n**适用场景**：\n- 验证代码优化效果\n- 回归测试\n- 性能基准对比\n- 内存泄漏排查\n\n## 你必须遵守的原则\n\n### 原则1：环境一致性原则\n\n**要求说明：**\n\n- **必须**：确保所有测试版本在相同的环境下运行（硬件、操作系统、依赖库版本）\n- **必须**：使用相同的环境变量配置\n- **必须**：使用相同的编译参数和优化级别\n- **禁止**：在不同环境或不同配置下对比测试结果\n\n### 原则2：代码版本明确原则\n\n**要求说明：**\n\n- **必须**：通过 git commit 或标签明确记录测试的代码版本\n- **必须**：在测试前验证关键代码位置的实现差异\n- **必须**：记录代码回退和恢复的详细过程\n- **禁止**：凭记忆或假设代码版本，必须实际验证\n\n### 原则3：测试稳定性原则\n\n**要求说明：**\n\n- **必须**：等待程序启动稳定后再采集数据\n- **必须**：使用相同的测试数据和输入参数\n- **必须**：在相同的运行时长后采集指标\n- **禁止**：在程序启动瞬间采集不稳定的数据\n\n### 原则4：数据完整性原则\n\n**要求说明：**\n\n- **必须**：采集完整的性能指标（内存、CPU、时间等）\n- **必须**：保存原始数据文件，避免人工抄写错误\n- **必须**：验证数据文件的完整性和大小\n- **禁止**：仅凭记忆或部分数据进行对比\n\n## 你必须执行的操作\n\n### 阶段1：准备阶段\n\n1. **确认代码版本**：\n   - 使用 git log 查看当前版本\n   - 读取关键代码文件，验证实现细节\n   - 记录 commit hash 和代码差异\n\n2. **设置测试环境**：\n   - 确认工作目录正确\n   - 设置必要的环境变量\n   - 验证依赖库路径\n\n3. **准备数据存储**：\n   - 创建数据保存目录\n   - 规划文件命名规范（如 version_old_status.txt）\n\n### 阶段2：测试阶段\n\n对于每个需要测试的版本：\n\n1. **代码切换**：\n   - 如需回退：使用 git checkout 或 git revert\n   - 如需恢复：使用 git checkout 回到原版本\n   - 验证代码切换成功\n\n2. **编译构建**：\n   - 清理旧的构建产物（可选）\n   - 使用统一的编译命令\n   - 验证编译成功\n\n3. **运行测试**：\n   - 启动程序（前台或后台）\n   - 获取准确的进程PID\n   - 等待程序稳定运行（如 sleep 3）\n\n4. **采集数据**：\n   - 采集性能指标（如 /proc/<PID>/status）\n   - 采集详细数据（如 /proc/<PID>/smaps）\n   - 保存到指定文件\n\n5. **清理进程**：\n   - 停止测试程序\n   - 验证进程已完全退出\n\n### 阶段3：对比分析\n\n1. **读取数据文件**：\n   - 读取各版本的测试数据\n   - 提取关键指标进行对比\n\n2. **差异分析**：\n   - 计算指标差异（绝对值和百分比）\n   - 识别显著变化\n   - 分析差异原因\n\n3. **生成报告**：\n   - 记录测试环境信息\n   - 展示关键指标对比\n   - 给出结论和建议\n\n### 阶段4：代码恢复\n\n1. **恢复原始版本**：\n   - 使用 git checkout 恢复到开发版本\n   - 验证代码恢复成功\n   - 确保不影响后续开发\n\n## 实践指导\n\n### 进程PID获取最佳实践\n\n**推荐方法**：\n```bash\n# 使用正则表达式避免匹配到grep自身\nps aux | grep '[p]rocess_name'\n# 或使用 pgrep\npgrep process_name\n```\n\n**禁止方法**：\n```bash\n# 错误：$! 获取的是后台命令的shell PID，不是目标进程\nps aux | grep process_name | grep -v grep\n```\n\n### Git 版本管理最佳实践\n\n**回退到旧版本**：\n```bash\n# 方法1：checkout到指定commit\ngit checkout <commit_hash>\n\n# 方法2：revert创建新提交\ngit revert <commit_hash>  # 需要解决冲突\n\n# 方法3：临时切换（不切换分支）\ngit checkout <commit_hash> -- <file_path>\n```\n\n**恢复到最新版本**：\n```bash\ngit checkout <branch_name>\n# 或\ngit checkout main\n```\n\n### 数据采集建议\n\n- **内存测试**：采集 VmRSS、RssAnon、Private_Dirty 等关键指标\n- **性能测试**：多次运行取平均值，避免偶然误差\n- **文件大小检查**：通过 ls -lh 验证数据完整性\n\n### 常见错误和注意事项\n\n1. **代码版本错误**：\n   - 症状：测试结果与预期不符\n   - 排查：读取关键代码，确认实现细节\n\n2. **环境不一致**：\n   - 症状：测试结果无法复现\n   - 预防：使用脚本自动化设置环境\n\n3. **数据采集时机错误**：\n   - 症状：数据波动大，不稳定\n   - 解决：等待程序稳定后再采集\n\n4. **进程未完全停止**：\n   - 症状：后续测试受影响\n   - 预防：使用 ps 验证进程已退出\n\n## 检查清单\n\n### 测试前检查\n\n- [ ] 当前代码版本已确认并记录\n- [ ] 测试环境已设置（环境变量、依赖库）\n- [ ] 数据保存目录已创建\n- [ ] 编译命令和参数已统一\n\n### 测试过程检查\n\n- [ ] 每个版本的代码已验证\n- [ ] 编译成功且无警告\n- [ ] 进程PID准确无误\n- [ ] 程序运行稳定后再采集数据\n- [ ] 数据文件已保存且大小合理\n\n### 测试后检查\n\n- [ ] 所有版本的测试已完成\n- [ ] 代码已恢复到原始版本\n- [ ] 临时进程已清理\n- [ ] 对比分析报告已生成\n- [ ] 测试数据已归档\n\n## 示例场景\n\n### Rust 代码内存对比测试\n\n**场景**：对比 Box::leak 和 Box::into_raw 两种实现的内存差异\n\n**步骤**：\n1. 记录当前版本（使用 Box::into_raw）\n2. 回退到旧版本（356f76e8^，使用 Box::leak）\n3. 编译并运行，采集内存数据\n4. 恢复到新版本\n5. 重新编译并运行，采集内存数据\n6. 对比 VmRSS、RssAnon 等指标\n7. 生成对比报告\n\n**关键命令**：\n```bash\n# 验证代码版本\nrg \"Box::(leak|into_raw)\" generator-rs/src/rt.rs\n\n# 编译\ncargo build --release --bin sche_benchmark\n\n# 运行并采集\nexport LD_LIBRARY_PATH=...\nnohup ./target/release/sche_benchmark > /tmp/log.txt 2>&1 &\nPID=$(ps aux | grep '[s]che_benchmark' | awk '{print $2}')\ncat /proc/$PID/status > /tmp/version_status.txt\ncat /proc/$PID/smaps > /tmp/version_smaps.txt\nkill $PID\n```",
  "scope": "global"
}