{
  "problem_type": "Rust并发测试稳定性修复",
  "content": "# Rust并发测试稳定性修复方法论\n\n## 问题重述\n在Rust项目中，测试套件可能因为并发竞态条件或共享资源冲突而出现间歇性失败，典型表现为：\n- 测试用例单独运行通过，完整套件运行失败\n- 断言失败与文件系统、网络等共享资源相关\n- 错误信息涉及路径不存在、文件锁定等问题\n\n## 可复用解决流程\n\n### 步骤1：问题识别与隔离\n1. **收集失败信息**\n   - 记录失败的测试用例名称\n   - 保存完整的错误输出和堆栈跟踪\n   - 注意是否涉及并发/共享资源\n\n2. **隔离测试**\n   ```bash\n   # 单独运行失败用例\n   cargo test test_name -- --nocapture\n  \n   # 多次运行确认稳定性\n   for i in {1..5}; do cargo test test_name; done\n   ```\n\n### 步骤2：根因分析\n1. **代码审查重点**\n   - 检查全局状态（static变量、文件系统、网络连接）\n   - 验证测试间的依赖关系\n   - 确认清理逻辑是否完善\n\n2. **添加诊断信息**\n   ```rust\n   // 在关键位置添加调试输出\n   eprintln!(\"Debug: path={:?}, exists={}\", path, Path::new(path).exists());\n   ```\n\n### 步骤3：修复策略\n1. **测试隔离**\n   - 确保每个测试用例独立设置和清理环境\n   - 使用随机化或唯一标识避免冲突\n\n2. **同步机制**\n   - 对共享资源使用适当的锁机制\n   - 考虑使用`std::sync::Mutex`或`std::sync::RwLock`\n\n3. **清理改进**\n   - 实现可靠的测试后清理逻辑\n   - 使用`Drop` trait确保资源正确释放\n\n### 步骤4：验证修复\n1. **稳定性测试**\n   ```bash\n   # 多次运行完整套件验证\n   for i in {1..10}; do cargo test; done\n   ```\n\n2. **并发测试**\n   ```bash\n   # 使用多个线程运行测试\n   cargo test -- --test-threads=8\n   ```\n\n## 注意事项\n- 避免测试间的顺序依赖\n- 谨慎使用全局可变状态\n- 确保临时文件使用唯一命名\n- 考虑使用临时目录库（如`tempfile` crate）\n\n## 可选步骤\n- 为不稳定的测试添加重试机制\n- 使用`#[serial]`属性标记需要串行执行的测试\n- 考虑使用内存模拟替代文件系统操作"
}