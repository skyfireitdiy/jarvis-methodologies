{
  "problem_type": "Rust测试中全局状态污染修复",
  "content": "# Rust测试中全局状态污染修复方法论\n\n## 问题重述\n当Rust项目使用全局静态变量（如AtomicUsize、Mutex等）时，测试用例之间可能共享状态导致测试失败，需要同时修复测试断言值。\n\n## 可复用解决流程\n\n### 阶段1：问题诊断\n1. **识别污染源**：使用`read_code`检查全局变量定义和使用\n2. **运行测试**：使用`execute_script`运行特定测试模块\n3. **定位失败点**：分析具体测试失败信息和断言差异\n\n### 阶段2：状态隔离修复\n1. **实现重置函数**：\n   ```rust\n   #[cfg(test)]\n   fn reset_state() {\n       GLOBAL_VAR.store(0, Ordering::Relaxed); // 对于AtomicUsize\n       // 或\n       *GLOBAL_VAR.lock().unwrap() = Default::default(); // 对于Mutex\n   }\n```\n\n2. **在测试前重置状态**：\n   ```rust\n   #[test]\n   fn test_case() {\n       reset_state();\n       // 测试逻辑\n   }\n```\n\n### 阶段3：断言值修正\n1. **分析计算逻辑**：理解实际业务逻辑（如8字节对齐）\n2. **计算正确期望值**：基于实际算法重新计算\n3. **批量修正断言**：更新所有相关测试用例\n\n### 阶段4：验证修复\n1. **单测试运行**：逐个验证测试通过\n2. **全测试运行**：确保无回归\n3. **并发测试运行**：验证状态隔离完全\n\n## 工具使用示例\n```bash\n# 诊断阶段\ncargo test --lib -- module::tests::test_name -- --nocapture\n\n# 运行特定测试模块\ncargo test --package package_name --lib module::tests\n\n# 检查全局变量\nrg \"static.*GLOBAL_VAR\" src/\n```\n\n## 注意事项\n- 对于顽固的状态污染，考虑使用`thread_local!`宏\n- 测试断言修正必须基于实际计算逻辑，不能简单调整期望值\n- 使用`Ordering::Relaxed`时要确保线程安全性要求\n- 记录所有修正的期望值以便后续回归测试\n\n## 可选步骤\n- 使用`loom`库进行并发测试验证\n- 实现自定义测试线程隔离机制\n- 将全局变量重构为依赖注入模式"
}